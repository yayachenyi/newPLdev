var cov_2jb3tfmh6w=function(){var path='/Users/fengyichen/pldev/newfolder/PrairieLearn/middlewares/authzCourseInstance.js',hash='374de4ccab800ac2534066e872d2e5a4b93d40db',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/fengyichen/pldev/newfolder/PrairieLearn/middlewares/authzCourseInstance.js',statementMap:{'0':{start:{line:1,column:10},end:{line:1,column:37}},'1':{start:{line:2,column:8},end:{line:2,column:25}},'2':{start:{line:4,column:13},end:{line:4,column:37}},'3':{start:{line:5,column:13},end:{line:5,column:37}},'4':{start:{line:6,column:12},end:{line:6,column:35}},'5':{start:{line:7,column:12},end:{line:7,column:35}},'6':{start:{line:8,column:16},end:{line:8,column:44}},'7':{start:{line:10,column:10},end:{line:10,column:44}},'8':{start:{line:12,column:0},end:{line:103,column:2}},'9':{start:{line:13,column:17},end:{line:20,column:5}},'10':{start:{line:21,column:4},end:{line:102,column:7}},'11':{start:{line:22,column:8},end:{line:22,column:35}},'12':{start:{line:22,column:28},end:{line:22,column:35}},'13':{start:{line:23,column:8},end:{line:23,column:80}},'14':{start:{line:23,column:34},end:{line:23,column:80}},'15':{start:{line:25,column:25},end:{line:25,column:44}},'16':{start:{line:26,column:8},end:{line:26,column:50}},'17':{start:{line:27,column:8},end:{line:27,column:68}},'18':{start:{line:29,column:42},end:{line:29,column:84}},'19':{start:{line:30,column:33},end:{line:30,column:66}},'20':{start:{line:33,column:8},end:{line:52,column:10}},'21':{start:{line:53,column:8},end:{line:53,column:53}},'22':{start:{line:55,column:8},end:{line:55,column:70}},'23':{start:{line:58,column:8},end:{line:61,column:9}},'24':{start:{line:60,column:12},end:{line:60,column:26}},'25':{start:{line:65,column:21},end:{line:69,column:9}},'26':{start:{line:70,column:8},end:{line:101,column:11}},'27':{start:{line:71,column:12},end:{line:71,column:39}},'28':{start:{line:71,column:32},end:{line:71,column:39}},'29':{start:{line:74,column:25},end:{line:84,column:13}},'30':{start:{line:85,column:12},end:{line:100,column:15}},'31':{start:{line:86,column:16},end:{line:86,column:43}},'32':{start:{line:86,column:36},end:{line:86,column:43}},'33':{start:{line:87,column:16},end:{line:87,column:88}},'34':{start:{line:87,column:42},end:{line:87,column:88}},'35':{start:{line:89,column:16},end:{line:89,column:64}},'36':{start:{line:90,column:16},end:{line:90,column:62}},'37':{start:{line:92,column:16},end:{line:92,column:59}},'38':{start:{line:93,column:16},end:{line:93,column:73}},'39':{start:{line:94,column:16},end:{line:94,column:73}},'40':{start:{line:95,column:16},end:{line:95,column:72}},'41':{start:{line:97,column:16},end:{line:97,column:77}},'42':{start:{line:98,column:16},end:{line:98,column:61}},'43':{start:{line:99,column:16},end:{line:99,column:23}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:12,column:17},end:{line:12,column:18}},loc:{start:{line:12,column:42},end:{line:103,column:1}},line:12},'1':{name:'(anonymous_1)',decl:{start:{line:21,column:59},end:{line:21,column:60}},loc:{start:{line:21,column:81},end:{line:102,column:5}},line:21},'2':{name:'(anonymous_2)',decl:{start:{line:70,column:51},end:{line:70,column:52}},loc:{start:{line:70,column:74},end:{line:101,column:9}},line:70},'3':{name:'(anonymous_3)',decl:{start:{line:85,column:77},end:{line:85,column:78}},loc:{start:{line:85,column:99},end:{line:100,column:13}},line:85}},branchMap:{'0':{loc:{start:{line:18,column:12},end:{line:18,column:52}},type:'binary-expr',locations:[{start:{line:18,column:12},end:{line:18,column:42}},{start:{line:18,column:46},end:{line:18,column:52}}],line:18},'1':{loc:{start:{line:19,column:20},end:{line:19,column:119}},type:'cond-expr',locations:[{start:{line:19,column:83},end:{line:19,column:112}},{start:{line:19,column:115},end:{line:19,column:119}}],line:19},'2':{loc:{start:{line:19,column:21},end:{line:19,column:79}},type:'binary-expr',locations:[{start:{line:19,column:21},end:{line:19,column:46}},{start:{line:19,column:50},end:{line:19,column:79}}],line:19},'3':{loc:{start:{line:22,column:8},end:{line:22,column:35}},type:'if',locations:[{start:{line:22,column:8},end:{line:22,column:35}},{start:{line:22,column:8},end:{line:22,column:35}}],line:22},'4':{loc:{start:{line:23,column:8},end:{line:23,column:80}},type:'if',locations:[{start:{line:23,column:8},end:{line:23,column:80}},{start:{line:23,column:8},end:{line:23,column:80}}],line:23},'5':{loc:{start:{line:58,column:8},end:{line:61,column:9}},type:'if',locations:[{start:{line:58,column:8},end:{line:61,column:9}},{start:{line:58,column:8},end:{line:61,column:9}}],line:58},'6':{loc:{start:{line:58,column:12},end:{line:58,column:143}},type:'binary-expr',locations:[{start:{line:58,column:12},end:{line:58,column:41}},{start:{line:58,column:45},end:{line:58,column:75}},{start:{line:58,column:79},end:{line:58,column:109}},{start:{line:58,column:113},end:{line:58,column:143}}],line:58},'7':{loc:{start:{line:71,column:12},end:{line:71,column:39}},type:'if',locations:[{start:{line:71,column:12},end:{line:71,column:39}},{start:{line:71,column:12},end:{line:71,column:39}}],line:71},'8':{loc:{start:{line:80,column:32},end:{line:80,column:124}},type:'cond-expr',locations:[{start:{line:80,column:63},end:{line:80,column:91}},{start:{line:80,column:94},end:{line:80,column:124}}],line:80},'9':{loc:{start:{line:81,column:33},end:{line:81,column:123}},type:'cond-expr',locations:[{start:{line:81,column:65},end:{line:81,column:94}},{start:{line:81,column:97},end:{line:81,column:123}}],line:81},'10':{loc:{start:{line:82,column:33},end:{line:82,column:123}},type:'cond-expr',locations:[{start:{line:82,column:65},end:{line:82,column:94}},{start:{line:82,column:97},end:{line:82,column:123}}],line:82},'11':{loc:{start:{line:83,column:33},end:{line:83,column:116}},type:'cond-expr',locations:[{start:{line:83,column:65},end:{line:83,column:94}},{start:{line:83,column:97},end:{line:83,column:116}}],line:83},'12':{loc:{start:{line:86,column:16},end:{line:86,column:43}},type:'if',locations:[{start:{line:86,column:16},end:{line:86,column:43}},{start:{line:86,column:16},end:{line:86,column:43}}],line:86},'13':{loc:{start:{line:87,column:16},end:{line:87,column:88}},type:'if',locations:[{start:{line:87,column:16},end:{line:87,column:88}},{start:{line:87,column:16},end:{line:87,column:88}}],line:87}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0},f:{'0':0,'1':0,'2':0,'3':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0,0,0],'7':[0,0],'8':[0,0],'9':[0,0],'10':[0,0],'11':[0,0],'12':[0,0],'13':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var ERR=(++cov_2jb3tfmh6w.s[0],require('async-stacktrace'));var _=(++cov_2jb3tfmh6w.s[1],require('lodash'));var logger=(++cov_2jb3tfmh6w.s[2],require('../lib/logger'));var config=(++cov_2jb3tfmh6w.s[3],require('../lib/config'));var error=(++cov_2jb3tfmh6w.s[4],require('../lib/error'));var sqldb=(++cov_2jb3tfmh6w.s[5],require('../lib/sqldb'));var sqlLoader=(++cov_2jb3tfmh6w.s[6],require('../lib/sql-loader'));var sql=(++cov_2jb3tfmh6w.s[7],sqlLoader.loadSqlEquiv(__filename));++cov_2jb3tfmh6w.s[8];module.exports=function(req,res,next){++cov_2jb3tfmh6w.f[0];var params=(++cov_2jb3tfmh6w.s[9],{authn_user_id:res.locals.authn_user.user_id,course_instance_id:req.params.course_instance_id,is_administrator:res.locals.is_administrator,req_date:res.locals.req_date,ip:(++cov_2jb3tfmh6w.b[0][0],req.headers['x-forwarded-for'])||(++cov_2jb3tfmh6w.b[0][1],req.ip),force_mode:(++cov_2jb3tfmh6w.b[2][0],config.authType=='none')&&(++cov_2jb3tfmh6w.b[2][1],req.cookies.pl_requested_mode)?(++cov_2jb3tfmh6w.b[1][0],req.cookies.pl_requested_mode):(++cov_2jb3tfmh6w.b[1][1],null)});++cov_2jb3tfmh6w.s[10];sqldb.queryZeroOrOneRow(sql.select_authz_data,params,function(err,result){++cov_2jb3tfmh6w.f[1];++cov_2jb3tfmh6w.s[11];if(ERR(err,next)){++cov_2jb3tfmh6w.b[3][0];++cov_2jb3tfmh6w.s[12];return;}else{++cov_2jb3tfmh6w.b[3][1];}++cov_2jb3tfmh6w.s[13];if(result.rowCount==0){++cov_2jb3tfmh6w.b[4][0];++cov_2jb3tfmh6w.s[14];return next(error.make(403,'Access denied'));}else{++cov_2jb3tfmh6w.b[4][1];}var authn_mode=(++cov_2jb3tfmh6w.s[15],result.rows[0].mode);++cov_2jb3tfmh6w.s[16];res.locals.course=result.rows[0].course;++cov_2jb3tfmh6w.s[17];res.locals.course_instance=result.rows[0].course_instance;var permissions_course_instance=(++cov_2jb3tfmh6w.s[18],result.rows[0].permissions_course_instance);var permissions_course=(++cov_2jb3tfmh6w.s[19],result.rows[0].permissions_course);// effective user data defaults to auth user data
++cov_2jb3tfmh6w.s[20];res.locals.authz_data={authn_user:_.cloneDeep(res.locals.authn_user),authn_role:permissions_course_instance.role,authn_mode:authn_mode,authn_has_instructor_view:permissions_course_instance.has_instructor_view,authn_has_instructor_edit:permissions_course_instance.has_instructor_edit,authn_course_role:permissions_course.course_role,authn_has_course_permission_view:permissions_course.has_course_permission_view,authn_has_course_permission_edit:permissions_course.has_course_permission_edit,authn_has_course_permission_own:permissions_course.has_course_permission_own,user:_.cloneDeep(res.locals.authn_user),role:permissions_course_instance.role,mode:authn_mode,has_instructor_view:permissions_course_instance.has_instructor_view,has_instructor_edit:permissions_course_instance.has_instructor_edit,course_role:permissions_course.course_role,has_course_permission_view:permissions_course.has_course_permission_view,has_course_permission_edit:permissions_course.has_course_permission_edit,has_course_permission_own:permissions_course.has_course_permission_own};++cov_2jb3tfmh6w.s[21];res.locals.user=res.locals.authz_data.user;// FIXME: debugging for #422
++cov_2jb3tfmh6w.s[22];logger.debug('Preliminary authz_data',res.locals.authz_data);// check whether we are requesting user data override
++cov_2jb3tfmh6w.s[23];if((++cov_2jb3tfmh6w.b[6][0],!req.cookies.pl_requested_uid)&&(++cov_2jb3tfmh6w.b[6][1],!req.cookies.pl_requested_role)&&(++cov_2jb3tfmh6w.b[6][2],!req.cookies.pl_requested_mode)&&(++cov_2jb3tfmh6w.b[6][3],!req.cookies.pl_requested_date)){++cov_2jb3tfmh6w.b[5][0];++cov_2jb3tfmh6w.s[24];// no user data override, just continue
return next();}else{++cov_2jb3tfmh6w.b[5][1];}// We are trying to override the user data.
// Ensure we are enrolled in this course (we are already authorized, so this must be ok).
var params=(++cov_2jb3tfmh6w.s[25],{course_instance_id:res.locals.course_instance.id,user_id:res.locals.authn_user.user_id,role:res.locals.authz_data.authn_role});++cov_2jb3tfmh6w.s[26];sqldb.query(sql.ensure_enrollment,params,function(err,_result){++cov_2jb3tfmh6w.f[2];++cov_2jb3tfmh6w.s[27];if(ERR(err,next)){++cov_2jb3tfmh6w.b[7][0];++cov_2jb3tfmh6w.s[28];return;}else{++cov_2jb3tfmh6w.b[7][1];}// now do the actual override
var params=(++cov_2jb3tfmh6w.s[29],{authn_user_id:res.locals.authn_user.user_id,authn_role:res.locals.authz_data.authn_role,server_mode:res.locals.authz_data.authn_mode,req_date:res.locals.req_date,course_instance_id:req.params.course_instance_id,requested_uid:req.cookies.pl_requested_uid?(++cov_2jb3tfmh6w.b[8][0],req.cookies.pl_requested_uid):(++cov_2jb3tfmh6w.b[8][1],res.locals.authz_data.user.uid),requested_role:req.cookies.pl_requested_role?(++cov_2jb3tfmh6w.b[9][0],req.cookies.pl_requested_role):(++cov_2jb3tfmh6w.b[9][1],res.locals.authz_data.role),requested_mode:req.cookies.pl_requested_mode?(++cov_2jb3tfmh6w.b[10][0],req.cookies.pl_requested_mode):(++cov_2jb3tfmh6w.b[10][1],res.locals.authz_data.mode),requested_date:req.cookies.pl_requested_date?(++cov_2jb3tfmh6w.b[11][0],req.cookies.pl_requested_date):(++cov_2jb3tfmh6w.b[11][1],res.locals.req_date)});++cov_2jb3tfmh6w.s[30];sqldb.queryZeroOrOneRow(sql.select_effective_authz_data,params,function(err,result){++cov_2jb3tfmh6w.f[3];++cov_2jb3tfmh6w.s[31];if(ERR(err,next)){++cov_2jb3tfmh6w.b[12][0];++cov_2jb3tfmh6w.s[32];return;}else{++cov_2jb3tfmh6w.b[12][1];}++cov_2jb3tfmh6w.s[33];if(result.rowCount==0){++cov_2jb3tfmh6w.b[13][0];++cov_2jb3tfmh6w.s[34];return next(error.make(403,'Access denied'));}else{++cov_2jb3tfmh6w.b[13][1];}++cov_2jb3tfmh6w.s[35];_.assign(res.locals.authz_data,result.rows[0]);++cov_2jb3tfmh6w.s[36];res.locals.req_date=result.rows[0].req_date;// remove all course permissions if we are emulating another user
++cov_2jb3tfmh6w.s[37];res.locals.authz_data.course_role='None';++cov_2jb3tfmh6w.s[38];res.locals.authz_data.has_course_permission_view=false;++cov_2jb3tfmh6w.s[39];res.locals.authz_data.has_course_permission_edit=false;++cov_2jb3tfmh6w.s[40];res.locals.authz_data.has_course_permission_own=false;// FIXME: debugging for #422
++cov_2jb3tfmh6w.s[41];logger.debug('Overridden authz_data',res.locals.authz_data);++cov_2jb3tfmh6w.s[42];res.locals.user=res.locals.authz_data.user;++cov_2jb3tfmh6w.s[43];next();});});});};