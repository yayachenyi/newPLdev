var cov_xlxn2a6e8=function(){var path='/Users/fengyichen/pldev/newfolder/PrairieLearn/pages/instructorAssessmentInstance/instructorAssessmentInstance.js',hash='761695e62254446dd69b8f56b151e73acd43698e',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/fengyichen/pldev/newfolder/PrairieLearn/pages/instructorAssessmentInstance/instructorAssessmentInstance.js',statementMap:{'0':{start:{line:1,column:10},end:{line:1,column:37}},'1':{start:{line:2,column:8},end:{line:2,column:25}},'2':{start:{line:3,column:19},end:{line:3,column:43}},'3':{start:{line:4,column:14},end:{line:4,column:32}},'4':{start:{line:5,column:13},end:{line:5,column:29}},'5':{start:{line:7,column:12},end:{line:7,column:38}},'6':{start:{line:8,column:12},end:{line:8,column:38}},'7':{start:{line:9,column:16},end:{line:9,column:47}},'8':{start:{line:11,column:10},end:{line:11,column:44}},'9':{start:{line:13,column:21},end:{line:26,column:1}},'10':{start:{line:14,column:4},end:{line:25,column:20}},'11':{start:{line:28,column:0},end:{line:49,column:3}},'12':{start:{line:29,column:4},end:{line:29,column:59}},'13':{start:{line:30,column:17},end:{line:30,column:76}},'14':{start:{line:31,column:4},end:{line:48,column:7}},'15':{start:{line:32,column:8},end:{line:32,column:35}},'16':{start:{line:32,column:28},end:{line:32,column:35}},'17':{start:{line:33,column:8},end:{line:33,column:94}},'18':{start:{line:35,column:21},end:{line:35,column:80}},'19':{start:{line:36,column:8},end:{line:47,column:11}},'20':{start:{line:37,column:12},end:{line:37,column:39}},'21':{start:{line:37,column:32},end:{line:37,column:39}},'22':{start:{line:38,column:12},end:{line:38,column:56}},'23':{start:{line:40,column:25},end:{line:40,column:84}},'24':{start:{line:41,column:12},end:{line:46,column:15}},'25':{start:{line:42,column:16},end:{line:42,column:43}},'26':{start:{line:42,column:36},end:{line:42,column:43}},'27':{start:{line:43,column:16},end:{line:43,column:45}},'28':{start:{line:45,column:16},end:{line:45,column:76}},'29':{start:{line:51,column:0},end:{line:78,column:3}},'30':{start:{line:52,column:4},end:{line:77,column:5}},'31':{start:{line:53,column:21},end:{line:53,column:80}},'32':{start:{line:54,column:8},end:{line:74,column:11}},'33':{start:{line:55,column:12},end:{line:55,column:39}},'34':{start:{line:55,column:32},end:{line:55,column:39}},'35':{start:{line:56,column:22},end:{line:56,column:33}},'36':{start:{line:57,column:29},end:{line:57,column:90}},'37':{start:{line:58,column:26},end:{line:67,column:14}},'38':{start:{line:59,column:16},end:{line:66,column:18}},'39':{start:{line:68,column:12},end:{line:68,column:45}},'40':{start:{line:69,column:12},end:{line:73,column:15}},'41':{start:{line:70,column:16},end:{line:70,column:66}},'42':{start:{line:70,column:25},end:{line:70,column:66}},'43':{start:{line:71,column:16},end:{line:71,column:52}},'44':{start:{line:72,column:16},end:{line:72,column:30}},'45':{start:{line:76,column:8},end:{line:76,column:68}},'46':{start:{line:80,column:0},end:{line:125,column:3}},'47':{start:{line:81,column:4},end:{line:81,column:66}},'48':{start:{line:81,column:52},end:{line:81,column:66}},'49':{start:{line:82,column:4},end:{line:124,column:5}},'50':{start:{line:83,column:21},end:{line:87,column:9}},'51':{start:{line:88,column:8},end:{line:91,column:11}},'52':{start:{line:89,column:12},end:{line:89,column:39}},'53':{start:{line:89,column:32},end:{line:89,column:39}},'54':{start:{line:90,column:12},end:{line:90,column:42}},'55':{start:{line:92,column:11},end:{line:124,column:5}},'56':{start:{line:93,column:21},end:{line:97,column:9}},'57':{start:{line:98,column:8},end:{line:101,column:11}},'58':{start:{line:99,column:12},end:{line:99,column:39}},'59':{start:{line:99,column:32},end:{line:99,column:39}},'60':{start:{line:100,column:12},end:{line:100,column:42}},'61':{start:{line:102,column:11},end:{line:124,column:5}},'62':{start:{line:103,column:21},end:{line:107,column:9}},'63':{start:{line:108,column:8},end:{line:111,column:11}},'64':{start:{line:109,column:12},end:{line:109,column:39}},'65':{start:{line:109,column:32},end:{line:109,column:39}},'66':{start:{line:110,column:12},end:{line:110,column:42}},'67':{start:{line:112,column:11},end:{line:124,column:5}},'68':{start:{line:113,column:21},end:{line:117,column:9}},'69':{start:{line:118,column:8},end:{line:121,column:11}},'70':{start:{line:119,column:12},end:{line:119,column:39}},'71':{start:{line:119,column:32},end:{line:119,column:39}},'72':{start:{line:120,column:12},end:{line:120,column:42}},'73':{start:{line:123,column:8},end:{line:123,column:95}},'74':{start:{line:127,column:0},end:{line:127,column:24}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:13,column:21},end:{line:13,column:22}},loc:{start:{line:13,column:38},end:{line:26,column:1}},line:13},'1':{name:'(anonymous_1)',decl:{start:{line:28,column:16},end:{line:28,column:17}},loc:{start:{line:28,column:41},end:{line:49,column:1}},line:28},'2':{name:'(anonymous_2)',decl:{start:{line:31,column:47},end:{line:31,column:48}},loc:{start:{line:31,column:69},end:{line:48,column:5}},line:31},'3':{name:'(anonymous_3)',decl:{start:{line:36,column:59},end:{line:36,column:60}},loc:{start:{line:36,column:81},end:{line:47,column:9}},line:36},'4':{name:'(anonymous_4)',decl:{start:{line:41,column:48},end:{line:41,column:49}},loc:{start:{line:41,column:70},end:{line:46,column:13}},line:41},'5':{name:'(anonymous_5)',decl:{start:{line:51,column:25},end:{line:51,column:26}},loc:{start:{line:51,column:50},end:{line:78,column:1}},line:51},'6':{name:'(anonymous_6)',decl:{start:{line:54,column:44},end:{line:54,column:45}},loc:{start:{line:54,column:66},end:{line:74,column:9}},line:54},'7':{name:'(anonymous_7)',decl:{start:{line:58,column:37},end:{line:58,column:38}},loc:{start:{line:58,column:51},end:{line:67,column:13}},line:58},'8':{name:'(anonymous_8)',decl:{start:{line:69,column:34},end:{line:69,column:35}},loc:{start:{line:69,column:53},end:{line:73,column:13}},line:69},'9':{name:'(anonymous_9)',decl:{start:{line:80,column:17},end:{line:80,column:18}},loc:{start:{line:80,column:42},end:{line:125,column:1}},line:80},'10':{name:'(anonymous_10)',decl:{start:{line:88,column:65},end:{line:88,column:66}},loc:{start:{line:88,column:88},end:{line:91,column:9}},line:88},'11':{name:'(anonymous_11)',decl:{start:{line:98,column:69},end:{line:98,column:70}},loc:{start:{line:98,column:92},end:{line:101,column:9}},line:98},'12':{name:'(anonymous_12)',decl:{start:{line:108,column:63},end:{line:108,column:64}},loc:{start:{line:108,column:86},end:{line:111,column:9}},line:108},'13':{name:'(anonymous_13)',decl:{start:{line:118,column:67},end:{line:118,column:68}},loc:{start:{line:118,column:90},end:{line:121,column:9}},line:118}},branchMap:{'0':{loc:{start:{line:32,column:8},end:{line:32,column:35}},type:'if',locations:[{start:{line:32,column:8},end:{line:32,column:35}},{start:{line:32,column:8},end:{line:32,column:35}}],line:32},'1':{loc:{start:{line:37,column:12},end:{line:37,column:39}},type:'if',locations:[{start:{line:37,column:12},end:{line:37,column:39}},{start:{line:37,column:12},end:{line:37,column:39}}],line:37},'2':{loc:{start:{line:42,column:16},end:{line:42,column:43}},type:'if',locations:[{start:{line:42,column:16},end:{line:42,column:43}},{start:{line:42,column:16},end:{line:42,column:43}}],line:42},'3':{loc:{start:{line:52,column:4},end:{line:77,column:5}},type:'if',locations:[{start:{line:52,column:4},end:{line:77,column:5}},{start:{line:52,column:4},end:{line:77,column:5}}],line:52},'4':{loc:{start:{line:55,column:12},end:{line:55,column:39}},type:'if',locations:[{start:{line:55,column:12},end:{line:55,column:39}},{start:{line:55,column:12},end:{line:55,column:39}}],line:55},'5':{loc:{start:{line:65,column:21},end:{line:65,column:73}},type:'cond-expr',locations:[{start:{line:65,column:42},end:{line:65,column:66}},{start:{line:65,column:69},end:{line:65,column:73}}],line:65},'6':{loc:{start:{line:70,column:16},end:{line:70,column:66}},type:'if',locations:[{start:{line:70,column:16},end:{line:70,column:66}},{start:{line:70,column:16},end:{line:70,column:66}}],line:70},'7':{loc:{start:{line:81,column:4},end:{line:81,column:66}},type:'if',locations:[{start:{line:81,column:4},end:{line:81,column:66}},{start:{line:81,column:4},end:{line:81,column:66}}],line:81},'8':{loc:{start:{line:82,column:4},end:{line:124,column:5}},type:'if',locations:[{start:{line:82,column:4},end:{line:124,column:5}},{start:{line:82,column:4},end:{line:124,column:5}}],line:82},'9':{loc:{start:{line:89,column:12},end:{line:89,column:39}},type:'if',locations:[{start:{line:89,column:12},end:{line:89,column:39}},{start:{line:89,column:12},end:{line:89,column:39}}],line:89},'10':{loc:{start:{line:92,column:11},end:{line:124,column:5}},type:'if',locations:[{start:{line:92,column:11},end:{line:124,column:5}},{start:{line:92,column:11},end:{line:124,column:5}}],line:92},'11':{loc:{start:{line:99,column:12},end:{line:99,column:39}},type:'if',locations:[{start:{line:99,column:12},end:{line:99,column:39}},{start:{line:99,column:12},end:{line:99,column:39}}],line:99},'12':{loc:{start:{line:102,column:11},end:{line:124,column:5}},type:'if',locations:[{start:{line:102,column:11},end:{line:124,column:5}},{start:{line:102,column:11},end:{line:124,column:5}}],line:102},'13':{loc:{start:{line:109,column:12},end:{line:109,column:39}},type:'if',locations:[{start:{line:109,column:12},end:{line:109,column:39}},{start:{line:109,column:12},end:{line:109,column:39}}],line:109},'14':{loc:{start:{line:112,column:11},end:{line:124,column:5}},type:'if',locations:[{start:{line:112,column:11},end:{line:124,column:5}},{start:{line:112,column:11},end:{line:124,column:5}}],line:112},'15':{loc:{start:{line:119,column:12},end:{line:119,column:39}},type:'if',locations:[{start:{line:119,column:12},end:{line:119,column:39}},{start:{line:119,column:12},end:{line:119,column:39}}],line:119}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0,'58':0,'59':0,'60':0,'61':0,'62':0,'63':0,'64':0,'65':0,'66':0,'67':0,'68':0,'69':0,'70':0,'71':0,'72':0,'73':0,'74':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0],'9':[0,0],'10':[0,0],'11':[0,0],'12':[0,0],'13':[0,0],'14':[0,0],'15':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var ERR=(++cov_xlxn2a6e8.s[0],require('async-stacktrace'));var _=(++cov_xlxn2a6e8.s[1],require('lodash'));var csvStringify=(++cov_xlxn2a6e8.s[2],require('csv').stringify);var express=(++cov_xlxn2a6e8.s[3],require('express'));var router=(++cov_xlxn2a6e8.s[4],express.Router());var error=(++cov_xlxn2a6e8.s[5],require('../../lib/error'));var sqldb=(++cov_xlxn2a6e8.s[6],require('../../lib/sqldb'));var sqlLoader=(++cov_xlxn2a6e8.s[7],require('../../lib/sql-loader'));var sql=(++cov_xlxn2a6e8.s[8],sqlLoader.loadSqlEquiv(__filename));++cov_xlxn2a6e8.s[9];var logCsvFilename=function(locals){++cov_xlxn2a6e8.f[0];++cov_xlxn2a6e8.s[10];return locals.course.short_name.replace(/\s+/g,'')+'_'+locals.course_instance.short_name+'_'+locals.assessment_set.abbreviation+locals.assessment.number+'_'+locals.instance_user.uid.replace(/[^a-z0-9]/g,'_')+'_'+locals.assessment_instance.number+'_'+'log.csv';};++cov_xlxn2a6e8.s[11];router.get('/',function(req,res,next){++cov_xlxn2a6e8.f[1];++cov_xlxn2a6e8.s[12];res.locals.logCsvFilename=logCsvFilename(res.locals);var params=(++cov_xlxn2a6e8.s[13],{assessment_instance_id:res.locals.assessment_instance.id});++cov_xlxn2a6e8.s[14];sqldb.queryOneRow(sql.select_data,params,function(err,result){++cov_xlxn2a6e8.f[2];++cov_xlxn2a6e8.s[15];if(ERR(err,next)){++cov_xlxn2a6e8.b[0][0];++cov_xlxn2a6e8.s[16];return;}else{++cov_xlxn2a6e8.b[0][1];}++cov_xlxn2a6e8.s[17];res.locals.assessment_instance_duration=result.rows[0].assessment_instance_duration;var params=(++cov_xlxn2a6e8.s[18],{assessment_instance_id:res.locals.assessment_instance.id});++cov_xlxn2a6e8.s[19];sqldb.query(sql.select_instance_questions,params,function(err,result){++cov_xlxn2a6e8.f[3];++cov_xlxn2a6e8.s[20];if(ERR(err,next)){++cov_xlxn2a6e8.b[1][0];++cov_xlxn2a6e8.s[21];return;}else{++cov_xlxn2a6e8.b[1][1];}++cov_xlxn2a6e8.s[22];res.locals.instance_questions=result.rows;var params=(++cov_xlxn2a6e8.s[23],{assessment_instance_id:res.locals.assessment_instance.id});++cov_xlxn2a6e8.s[24];sqldb.query(sql.select_log,params,function(err,result){++cov_xlxn2a6e8.f[4];++cov_xlxn2a6e8.s[25];if(ERR(err,next)){++cov_xlxn2a6e8.b[2][0];++cov_xlxn2a6e8.s[26];return;}else{++cov_xlxn2a6e8.b[2][1];}++cov_xlxn2a6e8.s[27];res.locals.log=result.rows;++cov_xlxn2a6e8.s[28];res.render(__filename.replace(/\.js$/,'.ejs'),res.locals);});});});});++cov_xlxn2a6e8.s[29];router.get('/:filename',function(req,res,next){++cov_xlxn2a6e8.f[5];++cov_xlxn2a6e8.s[30];if(req.params.filename==logCsvFilename(res.locals)){++cov_xlxn2a6e8.b[3][0];var params=(++cov_xlxn2a6e8.s[31],{assessment_instance_id:res.locals.assessment_instance.id});++cov_xlxn2a6e8.s[32];sqldb.query(sql.select_log,params,function(err,result){++cov_xlxn2a6e8.f[6];++cov_xlxn2a6e8.s[33];if(ERR(err,next)){++cov_xlxn2a6e8.b[4][0];++cov_xlxn2a6e8.s[34];return;}else{++cov_xlxn2a6e8.b[4][1];}var log=(++cov_xlxn2a6e8.s[35],result.rows);var csvHeaders=(++cov_xlxn2a6e8.s[36],['Time','Auth user','Event','Question','Variant','Data']);var csvData=(++cov_xlxn2a6e8.s[37],_.map(log,function(row){++cov_xlxn2a6e8.f[7];++cov_xlxn2a6e8.s[38];return[row.date_iso8601,row.auth_user_uid,row.event_name,row.qid,row.variant_number,row.data!=null?(++cov_xlxn2a6e8.b[5][0],JSON.stringify(row.data)):(++cov_xlxn2a6e8.b[5][1],null)];}));++cov_xlxn2a6e8.s[39];csvData.splice(0,0,csvHeaders);++cov_xlxn2a6e8.s[40];csvStringify(csvData,function(err,csv){++cov_xlxn2a6e8.f[8];++cov_xlxn2a6e8.s[41];if(err){++cov_xlxn2a6e8.b[6][0];++cov_xlxn2a6e8.s[42];throw Error('Error formatting CSV',err);}else{++cov_xlxn2a6e8.b[6][1];}++cov_xlxn2a6e8.s[43];res.attachment(req.params.filename);++cov_xlxn2a6e8.s[44];res.send(csv);});});}else{++cov_xlxn2a6e8.b[3][1];++cov_xlxn2a6e8.s[45];next(new Error('Unknown filename: '+req.params.filename));}});++cov_xlxn2a6e8.s[46];router.post('/',function(req,res,next){++cov_xlxn2a6e8.f[9];++cov_xlxn2a6e8.s[47];if(!res.locals.authz_data.has_instructor_edit){++cov_xlxn2a6e8.b[7][0];++cov_xlxn2a6e8.s[48];return next();}else{++cov_xlxn2a6e8.b[7][1];}++cov_xlxn2a6e8.s[49];if(req.body.__action=='edit_total_points'){++cov_xlxn2a6e8.b[8][0];let params=(++cov_xlxn2a6e8.s[50],[req.body.assessment_instance_id,req.body.points,res.locals.authn_user.user_id]);++cov_xlxn2a6e8.s[51];sqldb.call('assessment_instances_update_points',params,function(err,_result){++cov_xlxn2a6e8.f[10];++cov_xlxn2a6e8.s[52];if(ERR(err,next)){++cov_xlxn2a6e8.b[9][0];++cov_xlxn2a6e8.s[53];return;}else{++cov_xlxn2a6e8.b[9][1];}++cov_xlxn2a6e8.s[54];res.redirect(req.originalUrl);});}else{++cov_xlxn2a6e8.b[8][1];++cov_xlxn2a6e8.s[55];if(req.body.__action=='edit_total_score_perc'){++cov_xlxn2a6e8.b[10][0];let params=(++cov_xlxn2a6e8.s[56],[req.body.assessment_instance_id,req.body.score_perc,res.locals.authn_user.user_id]);++cov_xlxn2a6e8.s[57];sqldb.call('assessment_instances_update_score_perc',params,function(err,_result){++cov_xlxn2a6e8.f[11];++cov_xlxn2a6e8.s[58];if(ERR(err,next)){++cov_xlxn2a6e8.b[11][0];++cov_xlxn2a6e8.s[59];return;}else{++cov_xlxn2a6e8.b[11][1];}++cov_xlxn2a6e8.s[60];res.redirect(req.originalUrl);});}else{++cov_xlxn2a6e8.b[10][1];++cov_xlxn2a6e8.s[61];if(req.body.__action=='edit_question_points'){++cov_xlxn2a6e8.b[12][0];let params=(++cov_xlxn2a6e8.s[62],[req.body.instance_question_id,req.body.points,res.locals.authn_user.user_id]);++cov_xlxn2a6e8.s[63];sqldb.call('instance_questions_update_points',params,function(err,_result){++cov_xlxn2a6e8.f[12];++cov_xlxn2a6e8.s[64];if(ERR(err,next)){++cov_xlxn2a6e8.b[13][0];++cov_xlxn2a6e8.s[65];return;}else{++cov_xlxn2a6e8.b[13][1];}++cov_xlxn2a6e8.s[66];res.redirect(req.originalUrl);});}else{++cov_xlxn2a6e8.b[12][1];++cov_xlxn2a6e8.s[67];if(req.body.__action=='edit_question_score_perc'){++cov_xlxn2a6e8.b[14][0];let params=(++cov_xlxn2a6e8.s[68],[req.body.instance_question_id,req.body.score_perc,res.locals.authn_user.user_id]);++cov_xlxn2a6e8.s[69];sqldb.call('instance_questions_update_score_perc',params,function(err,_result){++cov_xlxn2a6e8.f[13];++cov_xlxn2a6e8.s[70];if(ERR(err,next)){++cov_xlxn2a6e8.b[15][0];++cov_xlxn2a6e8.s[71];return;}else{++cov_xlxn2a6e8.b[15][1];}++cov_xlxn2a6e8.s[72];res.redirect(req.originalUrl);});}else{++cov_xlxn2a6e8.b[14][1];++cov_xlxn2a6e8.s[73];return next(error.make(400,'unknown __action',{locals:res.locals,body:req.body}));}}}}});++cov_xlxn2a6e8.s[74];module.exports=router;