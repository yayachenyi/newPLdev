var cov_2buy7dnjgv=function(){var path='/Users/fengyichen/pldev/newfolder/PrairieLearn/sync/fromDisk/tags.js',hash='2e03017d67ff419e77035fe636d48aef3197524b',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/fengyichen/pldev/newfolder/PrairieLearn/sync/fromDisk/tags.js',statementMap:{'0':{start:{line:1,column:10},end:{line:1,column:37}},'1':{start:{line:2,column:8},end:{line:2,column:25}},'2':{start:{line:3,column:12},end:{line:3,column:28}},'3':{start:{line:5,column:13},end:{line:5,column:40}},'4':{start:{line:6,column:12},end:{line:6,column:38}},'5':{start:{line:7,column:13},end:{line:7,column:40}},'6':{start:{line:8,column:16},end:{line:8,column:47}},'7':{start:{line:10,column:10},end:{line:10,column:44}},'8':{start:{line:12,column:0},end:{line:92,column:2}},'9':{start:{line:14,column:8},end:{line:90,column:11}},'10':{start:{line:16,column:16},end:{line:16,column:56}},'11':{start:{line:17,column:29},end:{line:17,column:31}},'12':{start:{line:18,column:16},end:{line:45,column:19}},'13':{start:{line:19,column:20},end:{line:19,column:59}},'14':{start:{line:20,column:33},end:{line:26,column:21}},'15':{start:{line:27,column:20},end:{line:32,column:23}},'16':{start:{line:28,column:24},end:{line:28,column:55}},'17':{start:{line:28,column:48},end:{line:28,column:55}},'18':{start:{line:29,column:24},end:{line:29,column:51}},'19':{start:{line:30,column:24},end:{line:30,column:44}},'20':{start:{line:31,column:24},end:{line:31,column:39}},'21':{start:{line:34,column:20},end:{line:34,column:51}},'22':{start:{line:34,column:44},end:{line:34,column:51}},'23':{start:{line:37,column:33},end:{line:40,column:21}},'24':{start:{line:41,column:20},end:{line:44,column:23}},'25':{start:{line:42,column:24},end:{line:42,column:55}},'26':{start:{line:42,column:48},end:{line:42,column:55}},'27':{start:{line:43,column:24},end:{line:43,column:39}},'28':{start:{line:48,column:16},end:{line:48,column:54}},'29':{start:{line:49,column:33},end:{line:49,column:65}},'30':{start:{line:50,column:16},end:{line:85,column:19}},'31':{start:{line:51,column:20},end:{line:51,column:69}},'32':{start:{line:52,column:20},end:{line:52,column:42}},'33':{start:{line:53,column:41},end:{line:53,column:43}},'34':{start:{line:54,column:20},end:{line:81,column:23}},'35':{start:{line:55,column:24},end:{line:57,column:25}},'36':{start:{line:56,column:28},end:{line:56,column:104}},'37':{start:{line:58,column:37},end:{line:62,column:25}},'38':{start:{line:63,column:24},end:{line:67,column:27}},'39':{start:{line:64,column:28},end:{line:64,column:59}},'40':{start:{line:64,column:52},end:{line:64,column:59}},'41':{start:{line:65,column:28},end:{line:65,column:67}},'42':{start:{line:66,column:28},end:{line:66,column:43}},'43':{start:{line:69,column:24},end:{line:69,column:55}},'44':{start:{line:69,column:48},end:{line:69,column:55}},'45':{start:{line:72,column:24},end:{line:72,column:61}},'46':{start:{line:73,column:37},end:{line:76,column:25}},'47':{start:{line:77,column:24},end:{line:80,column:27}},'48':{start:{line:78,column:28},end:{line:78,column:59}},'49':{start:{line:78,column:52},end:{line:78,column:59}},'50':{start:{line:79,column:28},end:{line:79,column:43}},'51':{start:{line:83,column:20},end:{line:83,column:51}},'52':{start:{line:83,column:44},end:{line:83,column:51}},'53':{start:{line:84,column:20},end:{line:84,column:35}},'54':{start:{line:88,column:12},end:{line:88,column:43}},'55':{start:{line:88,column:36},end:{line:88,column:43}},'56':{start:{line:89,column:12},end:{line:89,column:27}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:13,column:10},end:{line:13,column:11}},loc:{start:{line:13,column:53},end:{line:91,column:5}},line:13},'1':{name:'(anonymous_1)',decl:{start:{line:15,column:12},end:{line:15,column:13}},loc:{start:{line:15,column:31},end:{line:46,column:13}},line:15},'2':{name:'(anonymous_2)',decl:{start:{line:18,column:55},end:{line:18,column:56}},loc:{start:{line:18,column:82},end:{line:33,column:17}},line:18},'3':{name:'(anonymous_3)',decl:{start:{line:27,column:56},end:{line:27,column:57}},loc:{start:{line:27,column:78},end:{line:32,column:21}},line:27},'4':{name:'(anonymous_4)',decl:{start:{line:33,column:19},end:{line:33,column:20}},loc:{start:{line:33,column:33},end:{line:45,column:17}},line:33},'5':{name:'(anonymous_5)',decl:{start:{line:41,column:64},end:{line:41,column:65}},loc:{start:{line:41,column:87},end:{line:44,column:21}},line:41},'6':{name:'(anonymous_6)',decl:{start:{line:47,column:12},end:{line:47,column:13}},loc:{start:{line:47,column:31},end:{line:86,column:13}},line:47},'7':{name:'(anonymous_7)',decl:{start:{line:50,column:50},end:{line:50,column:51}},loc:{start:{line:50,column:77},end:{line:82,column:17}},line:50},'8':{name:'(anonymous_8)',decl:{start:{line:54,column:50},end:{line:54,column:51}},loc:{start:{line:54,column:81},end:{line:68,column:21}},line:54},'9':{name:'(anonymous_9)',decl:{start:{line:63,column:69},end:{line:63,column:70}},loc:{start:{line:63,column:91},end:{line:67,column:25}},line:63},'10':{name:'(anonymous_10)',decl:{start:{line:68,column:23},end:{line:68,column:24}},loc:{start:{line:68,column:37},end:{line:81,column:21}},line:68},'11':{name:'(anonymous_11)',decl:{start:{line:77,column:77},end:{line:77,column:78}},loc:{start:{line:77,column:100},end:{line:80,column:25}},line:77},'12':{name:'(anonymous_12)',decl:{start:{line:82,column:19},end:{line:82,column:20}},loc:{start:{line:82,column:33},end:{line:85,column:17}},line:82},'13':{name:'(anonymous_13)',decl:{start:{line:87,column:11},end:{line:87,column:12}},loc:{start:{line:87,column:25},end:{line:90,column:9}},line:87}},branchMap:{'0':{loc:{start:{line:16,column:34},end:{line:16,column:55}},type:'binary-expr',locations:[{start:{line:16,column:34},end:{line:16,column:49}},{start:{line:16,column:53},end:{line:16,column:55}}],line:16},'1':{loc:{start:{line:28,column:24},end:{line:28,column:55}},type:'if',locations:[{start:{line:28,column:24},end:{line:28,column:55}},{start:{line:28,column:24},end:{line:28,column:55}}],line:28},'2':{loc:{start:{line:34,column:20},end:{line:34,column:51}},type:'if',locations:[{start:{line:34,column:20},end:{line:34,column:51}},{start:{line:34,column:20},end:{line:34,column:51}}],line:34},'3':{loc:{start:{line:42,column:24},end:{line:42,column:55}},type:'if',locations:[{start:{line:42,column:24},end:{line:42,column:55}},{start:{line:42,column:24},end:{line:42,column:55}}],line:42},'4':{loc:{start:{line:52,column:29},end:{line:52,column:41}},type:'binary-expr',locations:[{start:{line:52,column:29},end:{line:52,column:35}},{start:{line:52,column:39},end:{line:52,column:41}}],line:52},'5':{loc:{start:{line:55,column:24},end:{line:57,column:25}},type:'if',locations:[{start:{line:55,column:24},end:{line:57,column:25}},{start:{line:55,column:24},end:{line:57,column:25}}],line:55},'6':{loc:{start:{line:64,column:28},end:{line:64,column:59}},type:'if',locations:[{start:{line:64,column:28},end:{line:64,column:59}},{start:{line:64,column:28},end:{line:64,column:59}}],line:64},'7':{loc:{start:{line:69,column:24},end:{line:69,column:55}},type:'if',locations:[{start:{line:69,column:24},end:{line:69,column:55}},{start:{line:69,column:24},end:{line:69,column:55}}],line:69},'8':{loc:{start:{line:78,column:28},end:{line:78,column:59}},type:'if',locations:[{start:{line:78,column:28},end:{line:78,column:59}},{start:{line:78,column:28},end:{line:78,column:59}}],line:78},'9':{loc:{start:{line:83,column:20},end:{line:83,column:51}},type:'if',locations:[{start:{line:83,column:20},end:{line:83,column:51}},{start:{line:83,column:20},end:{line:83,column:51}}],line:83},'10':{loc:{start:{line:88,column:12},end:{line:88,column:43}},type:'if',locations:[{start:{line:88,column:12},end:{line:88,column:43}},{start:{line:88,column:12},end:{line:88,column:43}}],line:88}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0],'9':[0,0],'10':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var ERR=(++cov_2buy7dnjgv.s[0],require('async-stacktrace'));var _=(++cov_2buy7dnjgv.s[1],require('lodash'));var async=(++cov_2buy7dnjgv.s[2],require('async'));var logger=(++cov_2buy7dnjgv.s[3],require('../../lib/logger'));var sqldb=(++cov_2buy7dnjgv.s[4],require('../../lib/sqldb'));var config=(++cov_2buy7dnjgv.s[5],require('../../lib/config'));var sqlLoader=(++cov_2buy7dnjgv.s[6],require('../../lib/sql-loader'));var sql=(++cov_2buy7dnjgv.s[7],sqlLoader.loadSqlEquiv(__filename));++cov_2buy7dnjgv.s[8];module.exports={sync:function(courseInfo,questionDB,callback){++cov_2buy7dnjgv.f[0];++cov_2buy7dnjgv.s[9];async.series([function(callback){++cov_2buy7dnjgv.f[1];++cov_2buy7dnjgv.s[10];courseInfo.tags=(++cov_2buy7dnjgv.b[0][0],courseInfo.tags)||(++cov_2buy7dnjgv.b[0][1],[]);var tagIds=(++cov_2buy7dnjgv.s[11],[]);++cov_2buy7dnjgv.s[12];async.forEachOfSeries(courseInfo.tags,function(tag,i,callback){++cov_2buy7dnjgv.f[2];++cov_2buy7dnjgv.s[13];logger.debug('Syncing tag ',tag.name);var params=(++cov_2buy7dnjgv.s[14],{name:tag.name,number:i+1,color:tag.color,description:tag.description,course_id:courseInfo.courseId});++cov_2buy7dnjgv.s[15];sqldb.query(sql.insert_tag,params,function(err,result){++cov_2buy7dnjgv.f[3];++cov_2buy7dnjgv.s[16];if(ERR(err,callback)){++cov_2buy7dnjgv.b[1][0];++cov_2buy7dnjgv.s[17];return;}else{++cov_2buy7dnjgv.b[1][1];}++cov_2buy7dnjgv.s[18];tag.id=result.rows[0].id;++cov_2buy7dnjgv.s[19];tagIds.push(tag.id);++cov_2buy7dnjgv.s[20];callback(null);});},function(err){++cov_2buy7dnjgv.f[4];++cov_2buy7dnjgv.s[21];if(ERR(err,callback)){++cov_2buy7dnjgv.b[2][0];++cov_2buy7dnjgv.s[22];return;}else{++cov_2buy7dnjgv.b[2][1];}// delete topics from the DB that aren't on disk
var params=(++cov_2buy7dnjgv.s[23],{course_id:courseInfo.courseId,keep_tag_ids:tagIds});++cov_2buy7dnjgv.s[24];sqldb.query(sql.delete_unused_tags,params,function(err,_result){++cov_2buy7dnjgv.f[5];++cov_2buy7dnjgv.s[25];if(ERR(err,callback)){++cov_2buy7dnjgv.b[3][0];++cov_2buy7dnjgv.s[26];return;}else{++cov_2buy7dnjgv.b[3][1];}++cov_2buy7dnjgv.s[27];callback(null);});});},function(callback){++cov_2buy7dnjgv.f[6];++cov_2buy7dnjgv.s[28];logger.debug('Syncing question_tags');var tagsByName=(++cov_2buy7dnjgv.s[29],_.keyBy(courseInfo.tags,'name'));++cov_2buy7dnjgv.s[30];async.forEachOfSeries(questionDB,function(q,qid,callback){++cov_2buy7dnjgv.f[7];++cov_2buy7dnjgv.s[31];logger.debug('Syncing tags for question '+qid);++cov_2buy7dnjgv.s[32];q.tags=(++cov_2buy7dnjgv.b[4][0],q.tags)||(++cov_2buy7dnjgv.b[4][1],[]);var questionTagIds=(++cov_2buy7dnjgv.s[33],[]);++cov_2buy7dnjgv.s[34];async.forEachOfSeries(q.tags,function(tagName,i,callback){++cov_2buy7dnjgv.f[8];++cov_2buy7dnjgv.s[35];if(!_(tagsByName).has(tagName)){++cov_2buy7dnjgv.b[5][0];++cov_2buy7dnjgv.s[36];return callback(new Error('Question '+qid+', unknown tag: '+tagName));}else{++cov_2buy7dnjgv.b[5][1];}var params=(++cov_2buy7dnjgv.s[37],{question_id:q.id,tag_id:tagsByName[tagName].id,number:i+1});++cov_2buy7dnjgv.s[38];sqldb.query(sql.insert_question_tag,params,function(err,result){++cov_2buy7dnjgv.f[9];++cov_2buy7dnjgv.s[39];if(ERR(err,callback)){++cov_2buy7dnjgv.b[6][0];++cov_2buy7dnjgv.s[40];return;}else{++cov_2buy7dnjgv.b[6][1];}++cov_2buy7dnjgv.s[41];questionTagIds.push(result.rows[0].id);++cov_2buy7dnjgv.s[42];callback(null);});},function(err){++cov_2buy7dnjgv.f[10];++cov_2buy7dnjgv.s[43];if(ERR(err,callback)){++cov_2buy7dnjgv.b[7][0];++cov_2buy7dnjgv.s[44];return;}else{++cov_2buy7dnjgv.b[7][1];}// delete topics from the DB that aren't on disk
++cov_2buy7dnjgv.s[45];logger.debug('Deleting unused tags');var params=(++cov_2buy7dnjgv.s[46],{question_id:q.id,keep_question_tag_ids:questionTagIds});++cov_2buy7dnjgv.s[47];sqldb.query(sql.delete_unused_question_tags,params,function(err,_result){++cov_2buy7dnjgv.f[11];++cov_2buy7dnjgv.s[48];if(ERR(err,callback)){++cov_2buy7dnjgv.b[8][0];++cov_2buy7dnjgv.s[49];return;}else{++cov_2buy7dnjgv.b[8][1];}++cov_2buy7dnjgv.s[50];callback(null);});});},function(err){++cov_2buy7dnjgv.f[12];++cov_2buy7dnjgv.s[51];if(ERR(err,callback)){++cov_2buy7dnjgv.b[9][0];++cov_2buy7dnjgv.s[52];return;}else{++cov_2buy7dnjgv.b[9][1];}++cov_2buy7dnjgv.s[53];callback(null);});}],function(err){++cov_2buy7dnjgv.f[13];++cov_2buy7dnjgv.s[54];if(ERR(err,callback)){++cov_2buy7dnjgv.b[10][0];++cov_2buy7dnjgv.s[55];return;}else{++cov_2buy7dnjgv.b[10][1];}++cov_2buy7dnjgv.s[56];callback(null);});}};