var cov_2krv877i2k=function(){var path='/Users/fengyichen/pldev/newfolder/PrairieLearn/lib/externalGrader.js',hash='8c1d150357f67d8f0a0bc20323b93b6bff731c59',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/fengyichen/pldev/newfolder/PrairieLearn/lib/externalGrader.js',statementMap:{'0':{start:{line:1,column:12},end:{line:1,column:39}},'1':{start:{line:2,column:14},end:{line:2,column:30}},'2':{start:{line:3,column:12},end:{line:3,column:30}},'3':{start:{line:4,column:11},end:{line:4,column:30}},'4':{start:{line:6,column:15},end:{line:6,column:34}},'5':{start:{line:7,column:15},end:{line:7,column:34}},'6':{start:{line:8,column:14},end:{line:8,column:32}},'7':{start:{line:9,column:18},end:{line:9,column:41}},'8':{start:{line:10,column:30},end:{line:10,column:66}},'9':{start:{line:11,column:26},end:{line:11,column:56}},'10':{start:{line:12,column:28},end:{line:12,column:60}},'11':{start:{line:14,column:12},end:{line:14,column:46}},'12':{start:{line:16,column:0},end:{line:39,column:2}},'13':{start:{line:17,column:4},end:{line:17,column:43}},'14':{start:{line:18,column:4},end:{line:38,column:5}},'15':{start:{line:22,column:8},end:{line:27,column:9}},'16':{start:{line:23,column:12},end:{line:23,column:73}},'17':{start:{line:24,column:12},end:{line:24,column:57}},'18':{start:{line:26,column:12},end:{line:26,column:119}},'19':{start:{line:29,column:8},end:{line:29,column:49}},'20':{start:{line:30,column:8},end:{line:30,column:56}},'21':{start:{line:32,column:8},end:{line:32,column:23}},'22':{start:{line:35,column:8},end:{line:35,column:85}},'23':{start:{line:36,column:8},end:{line:36,column:58}},'24':{start:{line:37,column:8},end:{line:37,column:23}},'25':{start:{line:41,column:0},end:{line:58,column:2}},'26':{start:{line:42,column:19},end:{line:44,column:5}},'27':{start:{line:45,column:4},end:{line:57,column:7}},'28':{start:{line:46,column:8},end:{line:46,column:39}},'29':{start:{line:46,column:32},end:{line:46,column:39}},'30':{start:{line:53,column:12},end:{line:53,column:26}},'31':{start:{line:55,column:8},end:{line:55,column:92}},'32':{start:{line:56,column:8},end:{line:56,column:23}},'33':{start:{line:60,column:0},end:{line:70,column:2}},'34':{start:{line:61,column:4},end:{line:69,column:7}},'35':{start:{line:62,column:8},end:{line:65,column:11}},'36':{start:{line:63,column:12},end:{line:63,column:43}},'37':{start:{line:63,column:36},end:{line:63,column:43}},'38':{start:{line:64,column:12},end:{line:64,column:27}},'39':{start:{line:67,column:8},end:{line:67,column:39}},'40':{start:{line:67,column:32},end:{line:67,column:39}},'41':{start:{line:68,column:8},end:{line:68,column:23}},'42':{start:{line:72,column:0},end:{line:110,column:2}},'43':{start:{line:73,column:4},end:{line:91,column:5}},'44':{start:{line:74,column:8},end:{line:74,column:79}},'45':{start:{line:77,column:18},end:{line:86,column:9}},'46':{start:{line:89,column:8},end:{line:89,column:60}},'47':{start:{line:90,column:8},end:{line:90,column:15}},'48':{start:{line:93,column:4},end:{line:93,column:70}},'49':{start:{line:95,column:25},end:{line:95,column:119}},'50':{start:{line:96,column:4},end:{line:100,column:7}},'51':{start:{line:97,column:8},end:{line:99,column:11}},'52':{start:{line:98,column:12},end:{line:98,column:58}},'53':{start:{line:98,column:31},end:{line:98,column:48}},'54':{start:{line:98,column:51},end:{line:98,column:58}},'55':{start:{line:101,column:4},end:{line:106,column:7}},'56':{start:{line:104,column:8},end:{line:104,column:70}},'57':{start:{line:105,column:8},end:{line:105,column:76}},'58':{start:{line:107,column:4},end:{line:109,column:7}},'59':{start:{line:108,column:8},end:{line:108,column:47}},'60':{start:{line:113,column:4},end:{line:113,column:67}},'61':{start:{line:114,column:4},end:{line:114,column:22}},'62':{start:{line:115,column:26},end:{line:126,column:5}},'63':{start:{line:127,column:4},end:{line:127,column:66}},'64':{start:{line:131,column:17},end:{line:134,column:5}},'65':{start:{line:135,column:4},end:{line:139,column:7}},'66':{start:{line:136,column:8},end:{line:136,column:39}},'67':{start:{line:136,column:32},end:{line:136,column:39}},'68':{start:{line:137,column:8},end:{line:137,column:70}},'69':{start:{line:138,column:8},end:{line:138,column:23}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:16,column:22},end:{line:16,column:23}},loc:{start:{line:16,column:53},end:{line:39,column:1}},line:16},'1':{name:'(anonymous_1)',decl:{start:{line:41,column:33},end:{line:41,column:34}},loc:{start:{line:41,column:68},end:{line:58,column:1}},line:41},'2':{name:'(anonymous_2)',decl:{start:{line:45,column:59},end:{line:45,column:60}},loc:{start:{line:45,column:76},end:{line:57,column:5}},line:45},'3':{name:'(anonymous_3)',decl:{start:{line:60,column:34},end:{line:60,column:35}},loc:{start:{line:60,column:70},end:{line:70,column:1}},line:60},'4':{name:'(anonymous_4)',decl:{start:{line:61,column:32},end:{line:61,column:33}},loc:{start:{line:61,column:62},end:{line:66,column:5}},line:61},'5':{name:'(anonymous_5)',decl:{start:{line:62,column:55},end:{line:62,column:56}},loc:{start:{line:62,column:64},end:{line:65,column:9}},line:62},'6':{name:'(anonymous_6)',decl:{start:{line:66,column:7},end:{line:66,column:8}},loc:{start:{line:66,column:16},end:{line:69,column:5}},line:66},'7':{name:'(anonymous_7)',decl:{start:{line:72,column:34},end:{line:72,column:35}},loc:{start:{line:72,column:95},end:{line:110,column:1}},line:72},'8':{name:'(anonymous_8)',decl:{start:{line:96,column:30},end:{line:96,column:31}},loc:{start:{line:96,column:36},end:{line:100,column:5}},line:96},'9':{name:'(anonymous_9)',decl:{start:{line:97,column:48},end:{line:97,column:49}},loc:{start:{line:97,column:57},end:{line:99,column:9}},line:97},'10':{name:'(anonymous_10)',decl:{start:{line:98,column:25},end:{line:98,column:26}},loc:{start:{line:98,column:31},end:{line:98,column:48}},line:98},'11':{name:'(anonymous_11)',decl:{start:{line:101,column:31},end:{line:101,column:32}},loc:{start:{line:101,column:50},end:{line:106,column:5}},line:101},'12':{name:'(anonymous_12)',decl:{start:{line:107,column:29},end:{line:107,column:30}},loc:{start:{line:107,column:38},end:{line:109,column:5}},line:107},'13':{name:'handleGraderError',decl:{start:{line:112,column:9},end:{line:112,column:26}},loc:{start:{line:112,column:39},end:{line:128,column:1}},line:112},'14':{name:'updateJobSubmissionTime',decl:{start:{line:130,column:9},end:{line:130,column:32}},loc:{start:{line:130,column:59},end:{line:140,column:1}},line:130},'15':{name:'(anonymous_15)',decl:{start:{line:135,column:59},end:{line:135,column:60}},loc:{start:{line:135,column:77},end:{line:139,column:5}},line:135}},branchMap:{'0':{loc:{start:{line:18,column:4},end:{line:38,column:5}},type:'if',locations:[{start:{line:18,column:4},end:{line:38,column:5}},{start:{line:18,column:4},end:{line:38,column:5}}],line:18},'1':{loc:{start:{line:22,column:8},end:{line:27,column:9}},type:'if',locations:[{start:{line:22,column:8},end:{line:27,column:9}},{start:{line:22,column:8},end:{line:27,column:9}}],line:22},'2':{loc:{start:{line:46,column:8},end:{line:46,column:39}},type:'if',locations:[{start:{line:46,column:8},end:{line:46,column:39}},{start:{line:46,column:8},end:{line:46,column:39}}],line:46},'3':{loc:{start:{line:63,column:12},end:{line:63,column:43}},type:'if',locations:[{start:{line:63,column:12},end:{line:63,column:43}},{start:{line:63,column:12},end:{line:63,column:43}}],line:63},'4':{loc:{start:{line:67,column:8},end:{line:67,column:39}},type:'if',locations:[{start:{line:67,column:8},end:{line:67,column:39}},{start:{line:67,column:8},end:{line:67,column:39}}],line:67},'5':{loc:{start:{line:73,column:4},end:{line:91,column:5}},type:'if',locations:[{start:{line:73,column:4},end:{line:91,column:5}},{start:{line:73,column:4},end:{line:91,column:5}}],line:73},'6':{loc:{start:{line:98,column:12},end:{line:98,column:58}},type:'if',locations:[{start:{line:98,column:12},end:{line:98,column:58}},{start:{line:98,column:12},end:{line:98,column:58}}],line:98},'7':{loc:{start:{line:136,column:8},end:{line:136,column:39}},type:'if',locations:[{start:{line:136,column:8},end:{line:136,column:39}},{start:{line:136,column:8},end:{line:136,column:39}}],line:136}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0,'58':0,'59':0,'60':0,'61':0,'62':0,'63':0,'64':0,'65':0,'66':0,'67':0,'68':0,'69':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();const ERR=(++cov_2krv877i2k.s[0],require('async-stacktrace'));const async=(++cov_2krv877i2k.s[1],require('async'));const AWS=(++cov_2krv877i2k.s[2],require('aws-sdk'));const fs=(++cov_2krv877i2k.s[3],require('fs-extra'));const config=(++cov_2krv877i2k.s[4],require('./config'));const logger=(++cov_2krv877i2k.s[5],require('./logger'));const sqldb=(++cov_2krv877i2k.s[6],require('./sqldb'));const sqlLoader=(++cov_2krv877i2k.s[7],require('./sql-loader'));const externalGradingSocket=(++cov_2krv877i2k.s[8],require('./external-grading-socket'));const ExternalGraderSqs=(++cov_2krv877i2k.s[9],require('./externalGraderSqs'));const ExternalGraderLocal=(++cov_2krv877i2k.s[10],require('./externalGraderLocal'));const sql=(++cov_2krv877i2k.s[11],sqlLoader.loadSqlEquiv(__filename));++cov_2krv877i2k.s[12];module.exports.init=function(assessment,callback){++cov_2krv877i2k.f[0];++cov_2krv877i2k.s[13];module.exports.assessment=assessment;++cov_2krv877i2k.s[14];if(config.externalGradingUseAws){++cov_2krv877i2k.b[0][0];++cov_2krv877i2k.s[15];// So, this is terrible, but AWS will look relative to the Node working
// directory, not the current directory. So aws-config.json should be
// in the project root.
if(fs.existsSync('./aws-config.json')){++cov_2krv877i2k.b[1][0];++cov_2krv877i2k.s[16];logger.info('Loading AWS credentials for external grading.');++cov_2krv877i2k.s[17];AWS.config.loadFromPath('./aws-config.json');}else{++cov_2krv877i2k.b[1][1];++cov_2krv877i2k.s[18];logger.info('Missing \'aws-config.json\' in project root; this should only matter for local development.');}++cov_2krv877i2k.s[19];AWS.config.update({region:'us-east-2'});++cov_2krv877i2k.s[20];module.exports.grader=new ExternalGraderSqs();++cov_2krv877i2k.s[21];callback(null);}else{++cov_2krv877i2k.b[0][1];++cov_2krv877i2k.s[22];// local dev mode
logger.info('Not loading AWS credentials; external grader running locally.');++cov_2krv877i2k.s[23];module.exports.grader=new ExternalGraderLocal();++cov_2krv877i2k.s[24];callback(null);}};++cov_2krv877i2k.s[25];module.exports.beginGradingJob=function(grading_job_id,callback){++cov_2krv877i2k.f[1];const params=(++cov_2krv877i2k.s[26],{grading_job_id});++cov_2krv877i2k.s[27];sqldb.queryOneRow(sql.select_grading_job_info,params,(err,result)=>{++cov_2krv877i2k.f[2];++cov_2krv877i2k.s[28];if(ERR(err,callback)){++cov_2krv877i2k.b[2][0];++cov_2krv877i2k.s[29];return;}else{++cov_2krv877i2k.b[2][1];}const{grading_job,submission,variant,question,course}=(++cov_2krv877i2k.s[30],result.rows[0]);++cov_2krv877i2k.s[31];module.exports._beginGradingJob(grading_job,submission,variant,question,course);++cov_2krv877i2k.s[32];callback(null);});};++cov_2krv877i2k.s[33];module.exports.beginGradingJobs=function(grading_job_ids,callback){++cov_2krv877i2k.f[3];++cov_2krv877i2k.s[34];async.each(grading_job_ids,(grading_job_id,callback)=>{++cov_2krv877i2k.f[4];++cov_2krv877i2k.s[35];module.exports.beginGradingJob(grading_job_id,err=>{++cov_2krv877i2k.f[5];++cov_2krv877i2k.s[36];if(ERR(err,callback)){++cov_2krv877i2k.b[3][0];++cov_2krv877i2k.s[37];return;}else{++cov_2krv877i2k.b[3][1];}++cov_2krv877i2k.s[38];callback(null);});},err=>{++cov_2krv877i2k.f[6];++cov_2krv877i2k.s[39];if(ERR(err,callback)){++cov_2krv877i2k.b[4][0];++cov_2krv877i2k.s[40];return;}else{++cov_2krv877i2k.b[4][1];}++cov_2krv877i2k.s[41];callback(null);});};++cov_2krv877i2k.s[42];module.exports._beginGradingJob=function(grading_job,submission,variant,question,course){++cov_2krv877i2k.f[7];++cov_2krv877i2k.s[43];if(!question.external_grading_enabled){++cov_2krv877i2k.b[5][0];++cov_2krv877i2k.s[44];logger.info('External grading disabled for job id: '+grading_job.id);// Make the grade 0
let ret=(++cov_2krv877i2k.s[45],{gradingId:grading_job.id,grading:{score:0,feedback:{succeeded:true,message:'External grading is not enabled :('}}});// Send the grade out for processing and display
++cov_2krv877i2k.s[46];module.exports.assessment.processGradingResult(ret);++cov_2krv877i2k.s[47];return;}else{++cov_2krv877i2k.b[5][1];}++cov_2krv877i2k.s[48];logger.info(`Submitting external grading job ${grading_job.id}.`);const gradeRequest=(++cov_2krv877i2k.s[49],module.exports.grader.handleGradingRequest(grading_job,submission,variant,question,course));++cov_2krv877i2k.s[50];gradeRequest.on('submit',()=>{++cov_2krv877i2k.f[8];++cov_2krv877i2k.s[51];updateJobSubmissionTime(grading_job.id,err=>{++cov_2krv877i2k.f[9];++cov_2krv877i2k.s[52];if(ERR(err,()=>{++cov_2krv877i2k.f[10];++cov_2krv877i2k.s[53];return logger.error(err);})){++cov_2krv877i2k.b[6][0];++cov_2krv877i2k.s[54];return;}else{++cov_2krv877i2k.b[6][1];}});});++cov_2krv877i2k.s[55];gradeRequest.on('results',gradingResult=>{++cov_2krv877i2k.f[11];++cov_2krv877i2k.s[56];// This event will only be fired when running locally; in production,
// external grader results wil be delivered via webhook.
module.exports.assessment.processGradingResult(gradingResult);++cov_2krv877i2k.s[57];logger.info(`Successfully processed grading job ${grading_job.id}`);});++cov_2krv877i2k.s[58];gradeRequest.on('error',err=>{++cov_2krv877i2k.f[12];++cov_2krv877i2k.s[59];handleGraderError(grading_job.id,err);});};function handleGraderError(jobId,err){++cov_2krv877i2k.f[13];++cov_2krv877i2k.s[60];logger.error(`Error processing external grading job ${jobId}`);++cov_2krv877i2k.s[61];logger.error(err);const gradingResult=(++cov_2krv877i2k.s[62],{gradingId:jobId,grading:{score:0,startTime:null,endTime:null,feedback:{succeeded:false,message:err.toString()}}});++cov_2krv877i2k.s[63];module.exports.assessment.processGradingResult(gradingResult);}function updateJobSubmissionTime(grading_job_id,callback){++cov_2krv877i2k.f[14];var params=(++cov_2krv877i2k.s[64],{grading_job_id:grading_job_id,grading_submitted_at:new Date().toISOString()});++cov_2krv877i2k.s[65];sqldb.query(sql.update_grading_submitted_time,params,(err,_result)=>{++cov_2krv877i2k.f[15];++cov_2krv877i2k.s[66];if(ERR(err,callback)){++cov_2krv877i2k.b[7][0];++cov_2krv877i2k.s[67];return;}else{++cov_2krv877i2k.b[7][1];}++cov_2krv877i2k.s[68];externalGradingSocket.gradingLogStatusUpdated(grading_job_id);++cov_2krv877i2k.s[69];callback(null);});}