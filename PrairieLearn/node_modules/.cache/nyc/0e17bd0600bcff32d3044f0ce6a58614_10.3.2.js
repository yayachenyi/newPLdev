var cov_1nmw3wishm=function(){var path='/Users/fengyichen/pldev/newfolder/PrairieLearn/middlewares/authn.js',hash='e053ab4dd2fbada642d48861b9d5041fa25d71dc',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/fengyichen/pldev/newfolder/PrairieLearn/middlewares/authn.js',statementMap:{'0':{start:{line:1,column:10},end:{line:1,column:37}},'1':{start:{line:3,column:13},end:{line:3,column:37}},'2':{start:{line:4,column:11},end:{line:4,column:33}},'3':{start:{line:5,column:13},end:{line:5,column:37}},'4':{start:{line:6,column:12},end:{line:6,column:35}},'5':{start:{line:7,column:16},end:{line:7,column:44}},'6':{start:{line:9,column:10},end:{line:9,column:44}},'7':{start:{line:11,column:0},end:{line:77,column:2}},'8':{start:{line:12,column:4},end:{line:12,column:40}},'9':{start:{line:14,column:4},end:{line:18,column:5}},'10':{start:{line:16,column:8},end:{line:16,column:15}},'11':{start:{line:17,column:8},end:{line:17,column:15}},'12':{start:{line:20,column:4},end:{line:24,column:5}},'13':{start:{line:22,column:6},end:{line:22,column:13}},'14':{start:{line:23,column:6},end:{line:23,column:13}},'15':{start:{line:27,column:4},end:{line:50,column:5}},'16':{start:{line:28,column:22},end:{line:28,column:40}},'17':{start:{line:29,column:23},end:{line:29,column:33}},'18':{start:{line:30,column:22},end:{line:30,column:33}},'19':{start:{line:32,column:8},end:{line:36,column:9}},'20':{start:{line:33,column:12},end:{line:33,column:45}},'21':{start:{line:34,column:12},end:{line:34,column:38}},'22':{start:{line:35,column:12},end:{line:35,column:34}},'23':{start:{line:37,column:21},end:{line:42,column:9}},'24':{start:{line:43,column:8},end:{line:48,column:11}},'25':{start:{line:44,column:12},end:{line:44,column:39}},'26':{start:{line:44,column:32},end:{line:44,column:39}},'27':{start:{line:45,column:12},end:{line:45,column:56}},'28':{start:{line:46,column:12},end:{line:46,column:74}},'29':{start:{line:47,column:12},end:{line:47,column:19}},'30':{start:{line:49,column:8},end:{line:49,column:15}},'31':{start:{line:53,column:4},end:{line:57,column:5}},'32':{start:{line:54,column:8},end:{line:54,column:40}},'33':{start:{line:55,column:8},end:{line:55,column:26}},'34':{start:{line:56,column:8},end:{line:56,column:15}},'35':{start:{line:58,column:20},end:{line:58,column:110}},'36':{start:{line:59,column:4},end:{line:65,column:5}},'37':{start:{line:61,column:8},end:{line:61,column:50}},'38':{start:{line:62,column:8},end:{line:62,column:36}},'39':{start:{line:63,column:8},end:{line:63,column:26}},'40':{start:{line:64,column:8},end:{line:64,column:15}},'41':{start:{line:67,column:17},end:{line:69,column:5}},'42':{start:{line:70,column:4},end:{line:76,column:7}},'43':{start:{line:71,column:8},end:{line:71,column:35}},'44':{start:{line:71,column:28},end:{line:71,column:35}},'45':{start:{line:72,column:8},end:{line:72,column:109}},'46':{start:{line:72,column:34},end:{line:72,column:109}},'47':{start:{line:73,column:8},end:{line:73,column:52}},'48':{start:{line:74,column:8},end:{line:74,column:70}},'49':{start:{line:75,column:8},end:{line:75,column:15}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:11,column:17},end:{line:11,column:18}},loc:{start:{line:11,column:42},end:{line:77,column:1}},line:11},'1':{name:'(anonymous_1)',decl:{start:{line:43,column:51},end:{line:43,column:52}},loc:{start:{line:43,column:68},end:{line:48,column:9}},line:43},'2':{name:'(anonymous_2)',decl:{start:{line:70,column:41},end:{line:70,column:42}},loc:{start:{line:70,column:58},end:{line:76,column:5}},line:70}},branchMap:{'0':{loc:{start:{line:14,column:4},end:{line:18,column:5}},type:'if',locations:[{start:{line:14,column:4},end:{line:18,column:5}},{start:{line:14,column:4},end:{line:18,column:5}}],line:14},'1':{loc:{start:{line:20,column:4},end:{line:24,column:5}},type:'if',locations:[{start:{line:20,column:4},end:{line:24,column:5}},{start:{line:20,column:4},end:{line:24,column:5}}],line:20},'2':{loc:{start:{line:27,column:4},end:{line:50,column:5}},type:'if',locations:[{start:{line:27,column:4},end:{line:50,column:5}},{start:{line:27,column:4},end:{line:50,column:5}}],line:27},'3':{loc:{start:{line:32,column:8},end:{line:36,column:9}},type:'if',locations:[{start:{line:32,column:8},end:{line:36,column:9}},{start:{line:32,column:8},end:{line:36,column:9}}],line:32},'4':{loc:{start:{line:44,column:12},end:{line:44,column:39}},type:'if',locations:[{start:{line:44,column:12},end:{line:44,column:39}},{start:{line:44,column:12},end:{line:44,column:39}}],line:44},'5':{loc:{start:{line:53,column:4},end:{line:57,column:5}},type:'if',locations:[{start:{line:53,column:4},end:{line:57,column:5}},{start:{line:53,column:4},end:{line:57,column:5}}],line:53},'6':{loc:{start:{line:59,column:4},end:{line:65,column:5}},type:'if',locations:[{start:{line:59,column:4},end:{line:65,column:5}},{start:{line:59,column:4},end:{line:65,column:5}}],line:59},'7':{loc:{start:{line:71,column:8},end:{line:71,column:35}},type:'if',locations:[{start:{line:71,column:8},end:{line:71,column:35}},{start:{line:71,column:8},end:{line:71,column:35}}],line:71},'8':{loc:{start:{line:72,column:8},end:{line:72,column:109}},type:'if',locations:[{start:{line:72,column:8},end:{line:72,column:109}},{start:{line:72,column:8},end:{line:72,column:109}}],line:72}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0},f:{'0':0,'1':0,'2':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var ERR=(++cov_1nmw3wishm.s[0],require('async-stacktrace'));var config=(++cov_1nmw3wishm.s[1],require('../lib/config'));var csrf=(++cov_1nmw3wishm.s[2],require('../lib/csrf'));var logger=(++cov_1nmw3wishm.s[3],require('../lib/logger'));var sqldb=(++cov_1nmw3wishm.s[4],require('../lib/sqldb'));var sqlLoader=(++cov_1nmw3wishm.s[5],require('../lib/sql-loader'));var sql=(++cov_1nmw3wishm.s[6],sqlLoader.loadSqlEquiv(__filename));++cov_1nmw3wishm.s[7];module.exports=function(req,res,next){++cov_1nmw3wishm.f[0];++cov_1nmw3wishm.s[8];res.locals.is_administrator=false;++cov_1nmw3wishm.s[9];if(req.method==='OPTIONS'){++cov_1nmw3wishm.b[0][0];++cov_1nmw3wishm.s[10];// don't authenticate for OPTIONS requests, as these are just for CORS
next();++cov_1nmw3wishm.s[11];return;}else{++cov_1nmw3wishm.b[0][1];}++cov_1nmw3wishm.s[12];if(/^\/pl\/webhooks\//.test(req.path)){++cov_1nmw3wishm.b[1][0];++cov_1nmw3wishm.s[13];// Webhook callbacks should not be authenticated
next();++cov_1nmw3wishm.s[14];return;}else{++cov_1nmw3wishm.b[1][1];}// bypass auth for local /pl/ serving
++cov_1nmw3wishm.s[15];if(config.authType==='none'){++cov_1nmw3wishm.b[2][0];var authUid=(++cov_1nmw3wishm.s[16],'dev@illinois.edu');var authName=(++cov_1nmw3wishm.s[17],'Dev User');var authUin=(++cov_1nmw3wishm.s[18],'000000000');++cov_1nmw3wishm.s[19];if(req.cookies.pl_test_user=='test_student'){++cov_1nmw3wishm.b[3][0];++cov_1nmw3wishm.s[20];authUid='student@illinois.edu';++cov_1nmw3wishm.s[21];authName='Student User';++cov_1nmw3wishm.s[22];authUin='000000001';}else{++cov_1nmw3wishm.b[3][1];}let params=(++cov_1nmw3wishm.s[23],{uid:authUid,name:authName,uin:authUin,provider:'dev'});++cov_1nmw3wishm.s[24];sqldb.queryOneRow(sql.insert_user,params,(err,result)=>{++cov_1nmw3wishm.f[1];++cov_1nmw3wishm.s[25];if(ERR(err,next)){++cov_1nmw3wishm.b[4][0];++cov_1nmw3wishm.s[26];return;}else{++cov_1nmw3wishm.b[4][1];}++cov_1nmw3wishm.s[27];res.locals.authn_user=result.rows[0].user;++cov_1nmw3wishm.s[28];res.locals.is_administrator=result.rows[0].is_administrator;++cov_1nmw3wishm.s[29];next();});++cov_1nmw3wishm.s[30];return;}else{++cov_1nmw3wishm.b[2][1];}// otherwise look for auth cookies
++cov_1nmw3wishm.s[31];if(req.cookies.pl_authn==null){++cov_1nmw3wishm.b[5][0];++cov_1nmw3wishm.s[32];logger.error('no authn cookie');++cov_1nmw3wishm.s[33];res.redirect('/');++cov_1nmw3wishm.s[34];return;}else{++cov_1nmw3wishm.b[5][1];}var authnData=(++cov_1nmw3wishm.s[35],csrf.getCheckedData(req.cookies.pl_authn,config.secretKey,{maxAge:24*60*60*1000}));++cov_1nmw3wishm.s[36];if(authnData==null){++cov_1nmw3wishm.b[6][0];++cov_1nmw3wishm.s[37];// if CSRF checking failed then clear the cookie and redirect to / to prompt re-login
logger.error('authn cookie CSRF failure');++cov_1nmw3wishm.s[38];res.clearCookie('pl_authn');++cov_1nmw3wishm.s[39];res.redirect('/');++cov_1nmw3wishm.s[40];return;}else{++cov_1nmw3wishm.b[6][1];}let params=(++cov_1nmw3wishm.s[41],{user_id:authnData.user_id});++cov_1nmw3wishm.s[42];sqldb.query(sql.select_user,params,(err,result)=>{++cov_1nmw3wishm.f[2];++cov_1nmw3wishm.s[43];if(ERR(err,next)){++cov_1nmw3wishm.b[7][0];++cov_1nmw3wishm.s[44];return;}else{++cov_1nmw3wishm.b[7][1];}++cov_1nmw3wishm.s[45];if(result.rowCount==0){++cov_1nmw3wishm.b[8][0];++cov_1nmw3wishm.s[46];return next(new Error('user not found with user_id '+authnData.user_id));}else{++cov_1nmw3wishm.b[8][1];}++cov_1nmw3wishm.s[47];res.locals.authn_user=result.rows[0].user;++cov_1nmw3wishm.s[48];res.locals.is_administrator=result.rows[0].is_administrator;++cov_1nmw3wishm.s[49];next();});};