var cov_d9pncgs5n=function(){var path='/Users/fengyichen/pldev/newfolder/PrairieLearn/pages/instructorGradebook/instructorGradebook.js',hash='54cde8cc22dbeded49cb1a79adaae5f79172581f',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/fengyichen/pldev/newfolder/PrairieLearn/pages/instructorGradebook/instructorGradebook.js',statementMap:{'0':{start:{line:1,column:10},end:{line:1,column:37}},'1':{start:{line:2,column:8},end:{line:2,column:25}},'2':{start:{line:3,column:19},end:{line:3,column:43}},'3':{start:{line:4,column:14},end:{line:4,column:32}},'4':{start:{line:5,column:13},end:{line:5,column:29}},'5':{start:{line:7,column:12},end:{line:7,column:38}},'6':{start:{line:8,column:12},end:{line:8,column:38}},'7':{start:{line:9,column:16},end:{line:9,column:47}},'8':{start:{line:11,column:10},end:{line:11,column:44}},'9':{start:{line:13,column:18},end:{line:19,column:1}},'10':{start:{line:14,column:4},end:{line:18,column:26}},'11':{start:{line:21,column:0},end:{line:36,column:3}},'12':{start:{line:22,column:4},end:{line:22,column:53}},'13':{start:{line:23,column:17},end:{line:23,column:68}},'14':{start:{line:24,column:4},end:{line:35,column:7}},'15':{start:{line:25,column:8},end:{line:25,column:35}},'16':{start:{line:25,column:28},end:{line:25,column:35}},'17':{start:{line:26,column:8},end:{line:26,column:52}},'18':{start:{line:28,column:21},end:{line:28,column:72}},'19':{start:{line:29,column:8},end:{line:34,column:11}},'20':{start:{line:30,column:12},end:{line:30,column:39}},'21':{start:{line:30,column:32},end:{line:30,column:39}},'22':{start:{line:32,column:12},end:{line:32,column:49}},'23':{start:{line:33,column:12},end:{line:33,column:72}},'24':{start:{line:38,column:0},end:{line:64,column:3}},'25':{start:{line:39,column:4},end:{line:63,column:5}},'26':{start:{line:40,column:21},end:{line:40,column:72}},'27':{start:{line:41,column:8},end:{line:60,column:11}},'28':{start:{line:42,column:12},end:{line:42,column:39}},'29':{start:{line:42,column:32},end:{line:42,column:39}},'30':{start:{line:43,column:36},end:{line:43,column:47}},'31':{start:{line:44,column:12},end:{line:59,column:15}},'32':{start:{line:45,column:16},end:{line:45,column:43}},'33':{start:{line:45,column:36},end:{line:45,column:43}},'34':{start:{line:46,column:33},end:{line:46,column:44}},'35':{start:{line:48,column:33},end:{line:48,column:98}},'36':{start:{line:49,column:30},end:{line:52,column:18}},'37':{start:{line:50,column:40},end:{line:50,column:76}},'38':{start:{line:50,column:63},end:{line:50,column:75}},'39':{start:{line:51,column:20},end:{line:51,column:82}},'40':{start:{line:53,column:16},end:{line:53,column:49}},'41':{start:{line:54,column:16},end:{line:58,column:19}},'42':{start:{line:55,column:20},end:{line:55,column:47}},'43':{start:{line:55,column:40},end:{line:55,column:47}},'44':{start:{line:56,column:20},end:{line:56,column:56}},'45':{start:{line:57,column:20},end:{line:57,column:34}},'46':{start:{line:62,column:8},end:{line:62,column:68}},'47':{start:{line:66,column:0},end:{line:81,column:3}},'48':{start:{line:67,column:4},end:{line:67,column:66}},'49':{start:{line:67,column:52},end:{line:67,column:66}},'50':{start:{line:68,column:4},end:{line:80,column:5}},'51':{start:{line:69,column:21},end:{line:73,column:9}},'52':{start:{line:74,column:8},end:{line:77,column:11}},'53':{start:{line:75,column:12},end:{line:75,column:39}},'54':{start:{line:75,column:32},end:{line:75,column:39}},'55':{start:{line:76,column:12},end:{line:76,column:42}},'56':{start:{line:79,column:8},end:{line:79,column:95}},'57':{start:{line:83,column:0},end:{line:83,column:24}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:13,column:18},end:{line:13,column:19}},loc:{start:{line:13,column:35},end:{line:19,column:1}},line:13},'1':{name:'(anonymous_1)',decl:{start:{line:21,column:16},end:{line:21,column:17}},loc:{start:{line:21,column:41},end:{line:36,column:1}},line:21},'2':{name:'(anonymous_2)',decl:{start:{line:24,column:48},end:{line:24,column:49}},loc:{start:{line:24,column:70},end:{line:35,column:5}},line:24},'3':{name:'(anonymous_3)',decl:{start:{line:29,column:45},end:{line:29,column:46}},loc:{start:{line:29,column:67},end:{line:34,column:9}},line:29},'4':{name:'(anonymous_4)',decl:{start:{line:38,column:25},end:{line:38,column:26}},loc:{start:{line:38,column:50},end:{line:64,column:1}},line:38},'5':{name:'(anonymous_5)',decl:{start:{line:41,column:52},end:{line:41,column:53}},loc:{start:{line:41,column:74},end:{line:60,column:9}},line:41},'6':{name:'(anonymous_6)',decl:{start:{line:44,column:49},end:{line:44,column:50}},loc:{start:{line:44,column:71},end:{line:59,column:13}},line:44},'7':{name:'(anonymous_7)',decl:{start:{line:49,column:48},end:{line:49,column:49}},loc:{start:{line:49,column:62},end:{line:52,column:17}},line:49},'8':{name:'(anonymous_8)',decl:{start:{line:50,column:58},end:{line:50,column:59}},loc:{start:{line:50,column:63},end:{line:50,column:75}},line:50},'9':{name:'(anonymous_9)',decl:{start:{line:54,column:38},end:{line:54,column:39}},loc:{start:{line:54,column:57},end:{line:58,column:17}},line:54},'10':{name:'(anonymous_10)',decl:{start:{line:66,column:17},end:{line:66,column:18}},loc:{start:{line:66,column:42},end:{line:81,column:1}},line:66},'11':{name:'(anonymous_11)',decl:{start:{line:74,column:69},end:{line:74,column:70}},loc:{start:{line:74,column:92},end:{line:77,column:9}},line:74}},branchMap:{'0':{loc:{start:{line:25,column:8},end:{line:25,column:35}},type:'if',locations:[{start:{line:25,column:8},end:{line:25,column:35}},{start:{line:25,column:8},end:{line:25,column:35}}],line:25},'1':{loc:{start:{line:30,column:12},end:{line:30,column:39}},type:'if',locations:[{start:{line:30,column:12},end:{line:30,column:39}},{start:{line:30,column:12},end:{line:30,column:39}}],line:30},'2':{loc:{start:{line:39,column:4},end:{line:63,column:5}},type:'if',locations:[{start:{line:39,column:4},end:{line:63,column:5}},{start:{line:39,column:4},end:{line:63,column:5}}],line:39},'3':{loc:{start:{line:42,column:12},end:{line:42,column:39}},type:'if',locations:[{start:{line:42,column:12},end:{line:42,column:39}},{start:{line:42,column:12},end:{line:42,column:39}}],line:42},'4':{loc:{start:{line:45,column:16},end:{line:45,column:43}},type:'if',locations:[{start:{line:45,column:16},end:{line:45,column:43}},{start:{line:45,column:16},end:{line:45,column:43}}],line:45},'5':{loc:{start:{line:55,column:20},end:{line:55,column:47}},type:'if',locations:[{start:{line:55,column:20},end:{line:55,column:47}},{start:{line:55,column:20},end:{line:55,column:47}}],line:55},'6':{loc:{start:{line:67,column:4},end:{line:67,column:66}},type:'if',locations:[{start:{line:67,column:4},end:{line:67,column:66}},{start:{line:67,column:4},end:{line:67,column:66}}],line:67},'7':{loc:{start:{line:68,column:4},end:{line:80,column:5}},type:'if',locations:[{start:{line:68,column:4},end:{line:80,column:5}},{start:{line:68,column:4},end:{line:80,column:5}}],line:68},'8':{loc:{start:{line:75,column:12},end:{line:75,column:39}},type:'if',locations:[{start:{line:75,column:12},end:{line:75,column:39}},{start:{line:75,column:12},end:{line:75,column:39}}],line:75}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var ERR=(++cov_d9pncgs5n.s[0],require('async-stacktrace'));var _=(++cov_d9pncgs5n.s[1],require('lodash'));var csvStringify=(++cov_d9pncgs5n.s[2],require('csv').stringify);var express=(++cov_d9pncgs5n.s[3],require('express'));var router=(++cov_d9pncgs5n.s[4],express.Router());var error=(++cov_d9pncgs5n.s[5],require('../../lib/error'));var sqldb=(++cov_d9pncgs5n.s[6],require('../../lib/sqldb'));var sqlLoader=(++cov_d9pncgs5n.s[7],require('../../lib/sql-loader'));var sql=(++cov_d9pncgs5n.s[8],sqlLoader.loadSqlEquiv(__filename));++cov_d9pncgs5n.s[9];var csvFilename=function(locals){++cov_d9pncgs5n.f[0];++cov_d9pncgs5n.s[10];return locals.course.short_name.replace(/\s+/g,'')+'_'+locals.course_instance.short_name+'_'+'gradebook.csv';};++cov_d9pncgs5n.s[11];router.get('/',function(req,res,next){++cov_d9pncgs5n.f[1];++cov_d9pncgs5n.s[12];res.locals.csvFilename=csvFilename(res.locals);var params=(++cov_d9pncgs5n.s[13],{course_instance_id:res.locals.course_instance.id});++cov_d9pncgs5n.s[14];sqldb.query(sql.course_assessments,params,function(err,result){++cov_d9pncgs5n.f[2];++cov_d9pncgs5n.s[15];if(ERR(err,next)){++cov_d9pncgs5n.b[0][0];++cov_d9pncgs5n.s[16];return;}else{++cov_d9pncgs5n.b[0][1];}++cov_d9pncgs5n.s[17];res.locals.course_assessments=result.rows;var params=(++cov_d9pncgs5n.s[18],{course_instance_id:res.locals.course_instance.id});++cov_d9pncgs5n.s[19];sqldb.query(sql.user_scores,params,function(err,result){++cov_d9pncgs5n.f[3];++cov_d9pncgs5n.s[20];if(ERR(err,next)){++cov_d9pncgs5n.b[1][0];++cov_d9pncgs5n.s[21];return;}else{++cov_d9pncgs5n.b[1][1];}++cov_d9pncgs5n.s[22];res.locals.user_scores=result.rows;++cov_d9pncgs5n.s[23];res.render(__filename.replace(/\.js$/,'.ejs'),res.locals);});});});++cov_d9pncgs5n.s[24];router.get('/:filename',function(req,res,next){++cov_d9pncgs5n.f[4];++cov_d9pncgs5n.s[25];if(req.params.filename==csvFilename(res.locals)){++cov_d9pncgs5n.b[2][0];var params=(++cov_d9pncgs5n.s[26],{course_instance_id:res.locals.course_instance.id});++cov_d9pncgs5n.s[27];sqldb.query(sql.course_assessments,params,function(err,result){++cov_d9pncgs5n.f[5];++cov_d9pncgs5n.s[28];if(ERR(err,next)){++cov_d9pncgs5n.b[3][0];++cov_d9pncgs5n.s[29];return;}else{++cov_d9pncgs5n.b[3][1];}var courseAssessments=(++cov_d9pncgs5n.s[30],result.rows);++cov_d9pncgs5n.s[31];sqldb.query(sql.user_scores,params,function(err,result){++cov_d9pncgs5n.f[6];++cov_d9pncgs5n.s[32];if(ERR(err,next)){++cov_d9pncgs5n.b[4][0];++cov_d9pncgs5n.s[33];return;}else{++cov_d9pncgs5n.b[4][1];}var userScores=(++cov_d9pncgs5n.s[34],result.rows);var csvHeaders=(++cov_d9pncgs5n.s[35],['UID','Name','Role'].concat(_.map(courseAssessments,'label')));var csvData=(++cov_d9pncgs5n.s[36],_.map(userScores,function(row){++cov_d9pncgs5n.f[7];const score_percs=(++cov_d9pncgs5n.s[37],_.map(row.scores,s=>{++cov_d9pncgs5n.f[8];++cov_d9pncgs5n.s[38];return s.score_perc;}));++cov_d9pncgs5n.s[39];return[row.uid,row.user_name,row.role].concat(score_percs);}));++cov_d9pncgs5n.s[40];csvData.splice(0,0,csvHeaders);++cov_d9pncgs5n.s[41];csvStringify(csvData,function(err,csv){++cov_d9pncgs5n.f[9];++cov_d9pncgs5n.s[42];if(ERR(err,next)){++cov_d9pncgs5n.b[5][0];++cov_d9pncgs5n.s[43];return;}else{++cov_d9pncgs5n.b[5][1];}++cov_d9pncgs5n.s[44];res.attachment(req.params.filename);++cov_d9pncgs5n.s[45];res.send(csv);});});});}else{++cov_d9pncgs5n.b[2][1];++cov_d9pncgs5n.s[46];next(new Error('Unknown filename: '+req.params.filename));}});++cov_d9pncgs5n.s[47];router.post('/',function(req,res,next){++cov_d9pncgs5n.f[10];++cov_d9pncgs5n.s[48];if(!res.locals.authz_data.has_instructor_edit){++cov_d9pncgs5n.b[6][0];++cov_d9pncgs5n.s[49];return next();}else{++cov_d9pncgs5n.b[6][1];}++cov_d9pncgs5n.s[50];if(req.body.__action=='edit_total_score_perc'){++cov_d9pncgs5n.b[7][0];let params=(++cov_d9pncgs5n.s[51],[req.body.assessment_instance_id,req.body.score_perc,res.locals.authn_user.user_id]);++cov_d9pncgs5n.s[52];sqldb.call('assessment_instances_update_score_perc',params,function(err,_result){++cov_d9pncgs5n.f[11];++cov_d9pncgs5n.s[53];if(ERR(err,next)){++cov_d9pncgs5n.b[8][0];++cov_d9pncgs5n.s[54];return;}else{++cov_d9pncgs5n.b[8][1];}++cov_d9pncgs5n.s[55];res.redirect(req.originalUrl);});}else{++cov_d9pncgs5n.b[7][1];++cov_d9pncgs5n.s[56];return next(error.make(400,'unknown __action',{locals:res.locals,body:req.body}));}});++cov_d9pncgs5n.s[57];module.exports=router;