var cov_1lscukmpan=function(){var path='/Users/fengyichen/pldev/newfolder/PrairieLearn/sync/fromDisk/courseInstances.js',hash='273363a01e785b7b17ea4633ed0d62d36c3f5897',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/fengyichen/pldev/newfolder/PrairieLearn/sync/fromDisk/courseInstances.js',statementMap:{'0':{start:{line:1,column:10},end:{line:1,column:37}},'1':{start:{line:2,column:8},end:{line:2,column:25}},'2':{start:{line:3,column:11},end:{line:3,column:26}},'3':{start:{line:4,column:12},end:{line:4,column:28}},'4':{start:{line:6,column:13},end:{line:6,column:40}},'5':{start:{line:7,column:13},end:{line:7,column:40}},'6':{start:{line:8,column:12},end:{line:8,column:38}},'7':{start:{line:9,column:16},end:{line:9,column:47}},'8':{start:{line:11,column:10},end:{line:11,column:44}},'9':{start:{line:13,column:0},end:{line:144,column:2}},'10':{start:{line:15,column:19},end:{line:15,column:33}},'11':{start:{line:16,column:32},end:{line:16,column:34}},'12':{start:{line:17,column:8},end:{line:109,column:11}},'13':{start:{line:19,column:26},end:{line:19,column:30}},'14':{start:{line:20,column:16},end:{line:28,column:23}},'15':{start:{line:23,column:24},end:{line:27,column:25}},'16':{start:{line:24,column:28},end:{line:25,column:90}},'17':{start:{line:26,column:28},end:{line:26,column:41}},'18':{start:{line:29,column:16},end:{line:29,column:46}},'19':{start:{line:29,column:25},end:{line:29,column:46}},'20':{start:{line:30,column:16},end:{line:30,column:31}},'21':{start:{line:33,column:26},end:{line:33,column:30}},'22':{start:{line:34,column:16},end:{line:43,column:23}},'23':{start:{line:35,column:35},end:{line:35,column:124}},'24':{start:{line:35,column:69},end:{line:35,column:123}},'25':{start:{line:38,column:24},end:{line:42,column:25}},'26':{start:{line:39,column:28},end:{line:40,column:127}},'27':{start:{line:40,column:70},end:{line:40,column:117}},'28':{start:{line:41,column:28},end:{line:41,column:41}},'29':{start:{line:44,column:16},end:{line:44,column:46}},'30':{start:{line:44,column:25},end:{line:44,column:46}},'31':{start:{line:45,column:16},end:{line:45,column:31}},'32':{start:{line:48,column:16},end:{line:58,column:19}},'33':{start:{line:49,column:20},end:{line:49,column:81}},'34':{start:{line:50,column:20},end:{line:54,column:23}},'35':{start:{line:51,column:24},end:{line:51,column:55}},'36':{start:{line:51,column:48},end:{line:51,column:55}},'37':{start:{line:52,column:24},end:{line:52,column:200}},'38':{start:{line:52,column:49},end:{line:52,column:200}},'39':{start:{line:53,column:24},end:{line:53,column:39}},'40':{start:{line:56,column:20},end:{line:56,column:51}},'41':{start:{line:56,column:44},end:{line:56,column:51}},'42':{start:{line:57,column:20},end:{line:57,column:35}},'43':{start:{line:61,column:16},end:{line:84,column:19}},'44':{start:{line:62,column:20},end:{line:62,column:71}},'45':{start:{line:63,column:33},end:{line:70,column:21}},'46':{start:{line:71,column:20},end:{line:80,column:23}},'47':{start:{line:72,column:24},end:{line:72,column:55}},'48':{start:{line:72,column:48},end:{line:72,column:55}},'49':{start:{line:73,column:47},end:{line:73,column:64}},'50':{start:{line:74,column:24},end:{line:74,column:65}},'51':{start:{line:75,column:24},end:{line:75,column:75}},'52':{start:{line:76,column:24},end:{line:79,column:27}},'53':{start:{line:77,column:28},end:{line:77,column:59}},'54':{start:{line:77,column:52},end:{line:77,column:59}},'55':{start:{line:78,column:28},end:{line:78,column:43}},'56':{start:{line:82,column:20},end:{line:82,column:51}},'57':{start:{line:82,column:44},end:{line:82,column:51}},'58':{start:{line:83,column:20},end:{line:83,column:35}},'59':{start:{line:88,column:16},end:{line:88,column:70}},'60':{start:{line:89,column:29},end:{line:92,column:17}},'61':{start:{line:93,column:16},end:{line:96,column:19}},'62':{start:{line:94,column:20},end:{line:94,column:51}},'63':{start:{line:94,column:44},end:{line:94,column:51}},'64':{start:{line:95,column:20},end:{line:95,column:35}},'65':{start:{line:100,column:16},end:{line:100,column:77}},'66':{start:{line:101,column:16},end:{line:104,column:19}},'67':{start:{line:102,column:20},end:{line:102,column:51}},'68':{start:{line:102,column:44},end:{line:102,column:51}},'69':{start:{line:103,column:20},end:{line:103,column:35}},'70':{start:{line:107,column:12},end:{line:107,column:43}},'71':{start:{line:107,column:36},end:{line:107,column:43}},'72':{start:{line:108,column:12},end:{line:108,column:27}},'73':{start:{line:113,column:26},end:{line:113,column:58}},'74':{start:{line:114,column:8},end:{line:142,column:11}},'75':{start:{line:115,column:12},end:{line:115,column:82}},'76':{start:{line:116,column:25},end:{line:124,column:13}},'77':{start:{line:125,column:12},end:{line:128,column:15}},'78':{start:{line:126,column:16},end:{line:126,column:47}},'79':{start:{line:126,column:40},end:{line:126,column:47}},'80':{start:{line:127,column:16},end:{line:127,column:31}},'81':{start:{line:130,column:12},end:{line:130,column:43}},'82':{start:{line:130,column:36},end:{line:130,column:43}},'83':{start:{line:133,column:12},end:{line:133,column:96}},'84':{start:{line:134,column:25},end:{line:137,column:13}},'85':{start:{line:138,column:12},end:{line:141,column:15}},'86':{start:{line:139,column:16},end:{line:139,column:47}},'87':{start:{line:139,column:40},end:{line:139,column:47}},'88':{start:{line:140,column:16},end:{line:140,column:31}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:14,column:10},end:{line:14,column:11}},loc:{start:{line:14,column:59},end:{line:110,column:5}},line:14},'1':{name:'(anonymous_1)',decl:{start:{line:18,column:12},end:{line:18,column:13}},loc:{start:{line:18,column:31},end:{line:31,column:13}},line:18},'2':{name:'(anonymous_2)',decl:{start:{line:22,column:26},end:{line:22,column:27}},loc:{start:{line:22,column:58},end:{line:28,column:21}},line:22},'3':{name:'(anonymous_3)',decl:{start:{line:32,column:12},end:{line:32,column:13}},loc:{start:{line:32,column:31},end:{line:46,column:13}},line:32},'4':{name:'(anonymous_4)',decl:{start:{line:35,column:29},end:{line:35,column:30}},loc:{start:{line:35,column:35},end:{line:35,column:124}},line:35},'5':{name:'(anonymous_5)',decl:{start:{line:35,column:64},end:{line:35,column:65}},loc:{start:{line:35,column:69},end:{line:35,column:123}},line:35},'6':{name:'(anonymous_6)',decl:{start:{line:37,column:26},end:{line:37,column:27}},loc:{start:{line:37,column:54},end:{line:43,column:21}},line:37},'7':{name:'(anonymous_7)',decl:{start:{line:40,column:65},end:{line:40,column:66}},loc:{start:{line:40,column:70},end:{line:40,column:117}},line:40},'8':{name:'(anonymous_8)',decl:{start:{line:47,column:12},end:{line:47,column:13}},loc:{start:{line:47,column:31},end:{line:59,column:13}},line:47},'9':{name:'(anonymous_9)',decl:{start:{line:48,column:56},end:{line:48,column:57}},loc:{start:{line:48,column:116},end:{line:55,column:17}},line:48},'10':{name:'(anonymous_10)',decl:{start:{line:50,column:115},end:{line:50,column:116}},loc:{start:{line:50,column:137},end:{line:54,column:21}},line:50},'11':{name:'(anonymous_11)',decl:{start:{line:55,column:19},end:{line:55,column:20}},loc:{start:{line:55,column:33},end:{line:58,column:17}},line:55},'12':{name:'(anonymous_12)',decl:{start:{line:60,column:12},end:{line:60,column:13}},loc:{start:{line:60,column:31},end:{line:85,column:13}},line:60},'13':{name:'(anonymous_13)',decl:{start:{line:61,column:56},end:{line:61,column:57}},loc:{start:{line:61,column:116},end:{line:81,column:17}},line:61},'14':{name:'(anonymous_14)',decl:{start:{line:71,column:68},end:{line:71,column:69}},loc:{start:{line:71,column:90},end:{line:80,column:21}},line:71},'15':{name:'(anonymous_15)',decl:{start:{line:76,column:61},end:{line:76,column:62}},loc:{start:{line:76,column:75},end:{line:79,column:25}},line:76},'16':{name:'(anonymous_16)',decl:{start:{line:81,column:19},end:{line:81,column:20}},loc:{start:{line:81,column:33},end:{line:84,column:17}},line:81},'17':{name:'(anonymous_17)',decl:{start:{line:86,column:12},end:{line:86,column:13}},loc:{start:{line:86,column:31},end:{line:97,column:13}},line:86},'18':{name:'(anonymous_18)',decl:{start:{line:93,column:77},end:{line:93,column:78}},loc:{start:{line:93,column:100},end:{line:96,column:17}},line:93},'19':{name:'(anonymous_19)',decl:{start:{line:98,column:12},end:{line:98,column:13}},loc:{start:{line:98,column:31},end:{line:105,column:13}},line:98},'20':{name:'(anonymous_20)',decl:{start:{line:101,column:80},end:{line:101,column:81}},loc:{start:{line:101,column:103},end:{line:104,column:17}},line:101},'21':{name:'(anonymous_21)',decl:{start:{line:106,column:11},end:{line:106,column:12}},loc:{start:{line:106,column:25},end:{line:109,column:9}},line:106},'22':{name:'(anonymous_22)',decl:{start:{line:112,column:21},end:{line:112,column:22}},loc:{start:{line:112,column:56},end:{line:143,column:5}},line:112},'23':{name:'(anonymous_23)',decl:{start:{line:114,column:43},end:{line:114,column:44}},loc:{start:{line:114,column:73},end:{line:129,column:9}},line:114},'24':{name:'(anonymous_24)',decl:{start:{line:125,column:72},end:{line:125,column:73}},loc:{start:{line:125,column:95},end:{line:128,column:13}},line:125},'25':{name:'(anonymous_25)',decl:{start:{line:129,column:11},end:{line:129,column:12}},loc:{start:{line:129,column:25},end:{line:142,column:9}},line:129},'26':{name:'(anonymous_26)',decl:{start:{line:138,column:80},end:{line:138,column:81}},loc:{start:{line:138,column:103},end:{line:141,column:13}},line:138}},branchMap:{'0':{loc:{start:{line:23,column:24},end:{line:27,column:25}},type:'if',locations:[{start:{line:23,column:24},end:{line:27,column:25}},{start:{line:23,column:24},end:{line:27,column:25}}],line:23},'1':{loc:{start:{line:29,column:16},end:{line:29,column:46}},type:'if',locations:[{start:{line:29,column:16},end:{line:29,column:46}},{start:{line:29,column:16},end:{line:29,column:46}}],line:29},'2':{loc:{start:{line:35,column:41},end:{line:35,column:62}},type:'binary-expr',locations:[{start:{line:35,column:41},end:{line:35,column:56}},{start:{line:35,column:60},end:{line:35,column:62}}],line:35},'3':{loc:{start:{line:38,column:24},end:{line:42,column:25}},type:'if',locations:[{start:{line:38,column:24},end:{line:42,column:25}},{start:{line:38,column:24},end:{line:42,column:25}}],line:38},'4':{loc:{start:{line:44,column:16},end:{line:44,column:46}},type:'if',locations:[{start:{line:44,column:16},end:{line:44,column:46}},{start:{line:44,column:16},end:{line:44,column:46}}],line:44},'5':{loc:{start:{line:51,column:24},end:{line:51,column:55}},type:'if',locations:[{start:{line:51,column:24},end:{line:51,column:55}},{start:{line:51,column:24},end:{line:51,column:55}}],line:51},'6':{loc:{start:{line:52,column:24},end:{line:52,column:200}},type:'if',locations:[{start:{line:52,column:24},end:{line:52,column:200}},{start:{line:52,column:24},end:{line:52,column:200}}],line:52},'7':{loc:{start:{line:56,column:20},end:{line:56,column:51}},type:'if',locations:[{start:{line:56,column:20},end:{line:56,column:51}},{start:{line:56,column:20},end:{line:56,column:51}}],line:56},'8':{loc:{start:{line:69,column:42},end:{line:69,column:109}},type:'binary-expr',locations:[{start:{line:69,column:42},end:{line:69,column:65}},{start:{line:69,column:69},end:{line:69,column:88}},{start:{line:69,column:92},end:{line:69,column:109}}],line:69},'9':{loc:{start:{line:72,column:24},end:{line:72,column:55}},type:'if',locations:[{start:{line:72,column:24},end:{line:72,column:55}},{start:{line:72,column:24},end:{line:72,column:55}}],line:72},'10':{loc:{start:{line:77,column:28},end:{line:77,column:59}},type:'if',locations:[{start:{line:77,column:28},end:{line:77,column:59}},{start:{line:77,column:28},end:{line:77,column:59}}],line:77},'11':{loc:{start:{line:82,column:20},end:{line:82,column:51}},type:'if',locations:[{start:{line:82,column:20},end:{line:82,column:51}},{start:{line:82,column:20},end:{line:82,column:51}}],line:82},'12':{loc:{start:{line:94,column:20},end:{line:94,column:51}},type:'if',locations:[{start:{line:94,column:20},end:{line:94,column:51}},{start:{line:94,column:20},end:{line:94,column:51}}],line:94},'13':{loc:{start:{line:102,column:20},end:{line:102,column:51}},type:'if',locations:[{start:{line:102,column:20},end:{line:102,column:51}},{start:{line:102,column:20},end:{line:102,column:51}}],line:102},'14':{loc:{start:{line:107,column:12},end:{line:107,column:43}},type:'if',locations:[{start:{line:107,column:12},end:{line:107,column:43}},{start:{line:107,column:12},end:{line:107,column:43}}],line:107},'15':{loc:{start:{line:113,column:26},end:{line:113,column:58}},type:'binary-expr',locations:[{start:{line:113,column:26},end:{line:113,column:52}},{start:{line:113,column:56},end:{line:113,column:58}}],line:113},'16':{loc:{start:{line:119,column:22},end:{line:119,column:64}},type:'cond-expr',locations:[{start:{line:119,column:46},end:{line:119,column:57}},{start:{line:119,column:60},end:{line:119,column:64}}],line:119},'17':{loc:{start:{line:120,column:22},end:{line:120,column:64}},type:'cond-expr',locations:[{start:{line:120,column:46},end:{line:120,column:57}},{start:{line:120,column:60},end:{line:120,column:64}}],line:120},'18':{loc:{start:{line:121,column:28},end:{line:121,column:80}},type:'cond-expr',locations:[{start:{line:121,column:57},end:{line:121,column:73}},{start:{line:121,column:76},end:{line:121,column:80}}],line:121},'19':{loc:{start:{line:122,column:26},end:{line:122,column:74}},type:'cond-expr',locations:[{start:{line:122,column:53},end:{line:122,column:67}},{start:{line:122,column:70},end:{line:122,column:74}}],line:122},'20':{loc:{start:{line:123,column:29},end:{line:123,column:87}},type:'cond-expr',locations:[{start:{line:123,column:60},end:{line:123,column:78}},{start:{line:123,column:81},end:{line:123,column:87}}],line:123},'21':{loc:{start:{line:126,column:16},end:{line:126,column:47}},type:'if',locations:[{start:{line:126,column:16},end:{line:126,column:47}},{start:{line:126,column:16},end:{line:126,column:47}}],line:126},'22':{loc:{start:{line:130,column:12},end:{line:130,column:43}},type:'if',locations:[{start:{line:130,column:12},end:{line:130,column:43}},{start:{line:130,column:12},end:{line:130,column:43}}],line:130},'23':{loc:{start:{line:139,column:16},end:{line:139,column:47}},type:'if',locations:[{start:{line:139,column:16},end:{line:139,column:47}},{start:{line:139,column:16},end:{line:139,column:47}}],line:139}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0,'58':0,'59':0,'60':0,'61':0,'62':0,'63':0,'64':0,'65':0,'66':0,'67':0,'68':0,'69':0,'70':0,'71':0,'72':0,'73':0,'74':0,'75':0,'76':0,'77':0,'78':0,'79':0,'80':0,'81':0,'82':0,'83':0,'84':0,'85':0,'86':0,'87':0,'88':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0,0],'9':[0,0],'10':[0,0],'11':[0,0],'12':[0,0],'13':[0,0],'14':[0,0],'15':[0,0],'16':[0,0],'17':[0,0],'18':[0,0],'19':[0,0],'20':[0,0],'21':[0,0],'22':[0,0],'23':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var ERR=(++cov_1lscukmpan.s[0],require('async-stacktrace'));var _=(++cov_1lscukmpan.s[1],require('lodash'));var path=(++cov_1lscukmpan.s[2],require('path'));var async=(++cov_1lscukmpan.s[3],require('async'));var logger=(++cov_1lscukmpan.s[4],require('../../lib/logger'));var config=(++cov_1lscukmpan.s[5],require('../../lib/config'));var sqldb=(++cov_1lscukmpan.s[6],require('../../lib/sqldb'));var sqlLoader=(++cov_1lscukmpan.s[7],require('../../lib/sql-loader'));var sql=(++cov_1lscukmpan.s[8],sqlLoader.loadSqlEquiv(__filename));++cov_1lscukmpan.s[9];module.exports={sync:function(courseInfo,courseInstanceDB,callback){++cov_1lscukmpan.f[0];var that=(++cov_1lscukmpan.s[10],module.exports);var courseInstanceIds=(++cov_1lscukmpan.s[11],[]);++cov_1lscukmpan.s[12];async.series([function(callback){++cov_1lscukmpan.f[1];var err=(++cov_1lscukmpan.s[13],null);++cov_1lscukmpan.s[14];_(courseInstanceDB).groupBy('uuid').each(function(courseInstances,uuid){++cov_1lscukmpan.f[2];++cov_1lscukmpan.s[15];if(courseInstances.length>1){++cov_1lscukmpan.b[0][0];++cov_1lscukmpan.s[16];err=new Error('UUID '+uuid+' is used in multiple courseInstances: '+_.map(courseInstances,'directory').join());++cov_1lscukmpan.s[17];return false;// terminate each()
}else{++cov_1lscukmpan.b[0][1];}});++cov_1lscukmpan.s[18];if(err){++cov_1lscukmpan.b[1][0];++cov_1lscukmpan.s[19];return callback(err);}else{++cov_1lscukmpan.b[1][1];}++cov_1lscukmpan.s[20];callback(null);},function(callback){++cov_1lscukmpan.f[3];var err=(++cov_1lscukmpan.s[21],null);++cov_1lscukmpan.s[22];_(courseInstanceDB).flatMap(ci=>{++cov_1lscukmpan.f[4];++cov_1lscukmpan.s[23];return _.map((++cov_1lscukmpan.b[2][0],ci.assessmentDB)||(++cov_1lscukmpan.b[2][1],[]),a=>{++cov_1lscukmpan.f[5];++cov_1lscukmpan.s[24];return _.assign(a,{course_instance_directory:ci.directory});});}).groupBy('uuid').each(function(assessments,uuid){++cov_1lscukmpan.f[6];++cov_1lscukmpan.s[25];if(assessments.length>1){++cov_1lscukmpan.b[3][0];++cov_1lscukmpan.s[26];err=new Error('UUID '+uuid+' is used in multiple assessments: '+_.map(assessments,a=>{++cov_1lscukmpan.f[7];++cov_1lscukmpan.s[27];return a.course_instance_directory+'/'+a.directory;}).join());++cov_1lscukmpan.s[28];return false;// terminate each()
}else{++cov_1lscukmpan.b[3][1];}});++cov_1lscukmpan.s[29];if(err){++cov_1lscukmpan.b[4][0];++cov_1lscukmpan.s[30];return callback(err);}else{++cov_1lscukmpan.b[4][1];}++cov_1lscukmpan.s[31];callback(null);},function(callback){++cov_1lscukmpan.f[8];++cov_1lscukmpan.s[32];async.forEachOfSeries(courseInstanceDB,function(courseInstance,courseInstanceShortName,callback){++cov_1lscukmpan.f[9];++cov_1lscukmpan.s[33];logger.debug('Checking uuid for '+courseInstanceShortName);++cov_1lscukmpan.s[34];sqldb.call('course_instances_with_uuid_elsewhere',[courseInfo.courseId,courseInstance.uuid],function(err,result){++cov_1lscukmpan.f[10];++cov_1lscukmpan.s[35];if(ERR(err,callback)){++cov_1lscukmpan.b[5][0];++cov_1lscukmpan.s[36];return;}else{++cov_1lscukmpan.b[5][1];}++cov_1lscukmpan.s[37];if(result.rowCount>0){++cov_1lscukmpan.b[6][0];++cov_1lscukmpan.s[38];return callback(new Error('UUID '+courseInstance.uuid+' from course instance '+courseInstanceShortName+' already in use in different course'));}else{++cov_1lscukmpan.b[6][1];}++cov_1lscukmpan.s[39];callback(null);});},function(err){++cov_1lscukmpan.f[11];++cov_1lscukmpan.s[40];if(ERR(err,callback)){++cov_1lscukmpan.b[7][0];++cov_1lscukmpan.s[41];return;}else{++cov_1lscukmpan.b[7][1];}++cov_1lscukmpan.s[42];callback(null);});},function(callback){++cov_1lscukmpan.f[12];++cov_1lscukmpan.s[43];async.forEachOfSeries(courseInstanceDB,function(courseInstance,courseInstanceShortName,callback){++cov_1lscukmpan.f[13];++cov_1lscukmpan.s[44];logger.debug('Syncing '+courseInstance.longName);var params=(++cov_1lscukmpan.s[45],{course_id:courseInfo.courseId,uuid:courseInstance.uuid,short_name:courseInstanceShortName,long_name:courseInstance.longName,number:courseInstance.number,display_timezone:(++cov_1lscukmpan.b[8][0],courseInstance.timezone)||(++cov_1lscukmpan.b[8][1],courseInfo.timezone)||(++cov_1lscukmpan.b[8][2],'America/Chicago')});++cov_1lscukmpan.s[46];sqldb.query(sql.insert_course_instance,params,function(err,result){++cov_1lscukmpan.f[14];++cov_1lscukmpan.s[47];if(ERR(err,callback)){++cov_1lscukmpan.b[9][0];++cov_1lscukmpan.s[48];return;}else{++cov_1lscukmpan.b[9][1];}var courseInstanceId=(++cov_1lscukmpan.s[49],result.rows[0].id);++cov_1lscukmpan.s[50];courseInstanceIds.push(courseInstanceId);++cov_1lscukmpan.s[51];courseInstance.courseInstanceId=courseInstanceId;++cov_1lscukmpan.s[52];that.syncAccessRules(courseInstance,function(err){++cov_1lscukmpan.f[15];++cov_1lscukmpan.s[53];if(ERR(err,callback)){++cov_1lscukmpan.b[10][0];++cov_1lscukmpan.s[54];return;}else{++cov_1lscukmpan.b[10][1];}++cov_1lscukmpan.s[55];callback(null);});});},function(err){++cov_1lscukmpan.f[16];++cov_1lscukmpan.s[56];if(ERR(err,callback)){++cov_1lscukmpan.b[11][0];++cov_1lscukmpan.s[57];return;}else{++cov_1lscukmpan.b[11][1];}++cov_1lscukmpan.s[58];callback(null);});},function(callback){++cov_1lscukmpan.f[17];++cov_1lscukmpan.s[59];// soft-delete courseInstances from the DB that aren't on disk
logger.debug('Soft-deleting unused course_instances');var params=(++cov_1lscukmpan.s[60],{course_id:courseInfo.courseId,keep_course_instance_ids:courseInstanceIds});++cov_1lscukmpan.s[61];sqldb.query(sql.soft_delete_unused_course_instances,params,function(err,_result){++cov_1lscukmpan.f[18];++cov_1lscukmpan.s[62];if(ERR(err,callback)){++cov_1lscukmpan.b[12][0];++cov_1lscukmpan.s[63];return;}else{++cov_1lscukmpan.b[12][1];}++cov_1lscukmpan.s[64];callback(null);});},function(callback){++cov_1lscukmpan.f[19];++cov_1lscukmpan.s[65];// delete access rules from DB that don't correspond to assessments
logger.debug('Deleting unused course_instance_access_rules');++cov_1lscukmpan.s[66];sqldb.query(sql.delete_unused_course_instance_access_rules,[],function(err,_result){++cov_1lscukmpan.f[20];++cov_1lscukmpan.s[67];if(ERR(err,callback)){++cov_1lscukmpan.b[13][0];++cov_1lscukmpan.s[68];return;}else{++cov_1lscukmpan.b[13][1];}++cov_1lscukmpan.s[69];callback(null);});}],function(err){++cov_1lscukmpan.f[21];++cov_1lscukmpan.s[70];if(ERR(err,callback)){++cov_1lscukmpan.b[14][0];++cov_1lscukmpan.s[71];return;}else{++cov_1lscukmpan.b[14][1];}++cov_1lscukmpan.s[72];callback(null);});},syncAccessRules:function(courseInstance,callback){++cov_1lscukmpan.f[22];var allowAccess=(++cov_1lscukmpan.s[73],(++cov_1lscukmpan.b[15][0],courseInstance.allowAccess)||(++cov_1lscukmpan.b[15][1],[]));++cov_1lscukmpan.s[74];async.forEachOfSeries(allowAccess,function(dbRule,i,callback){++cov_1lscukmpan.f[23];++cov_1lscukmpan.s[75];logger.debug('Syncing course instance access rule number '+(i+1));var params=(++cov_1lscukmpan.s[76],{course_instance_id:courseInstance.courseInstanceId,number:i+1,role:_(dbRule).has('role')?(++cov_1lscukmpan.b[16][0],dbRule.role):(++cov_1lscukmpan.b[16][1],null),uids:_(dbRule).has('uids')?(++cov_1lscukmpan.b[17][0],dbRule.uids):(++cov_1lscukmpan.b[17][1],null),start_date:_(dbRule).has('startDate')?(++cov_1lscukmpan.b[18][0],dbRule.startDate):(++cov_1lscukmpan.b[18][1],null),end_date:_(dbRule).has('endDate')?(++cov_1lscukmpan.b[19][0],dbRule.endDate):(++cov_1lscukmpan.b[19][1],null),institution:_(dbRule).has('institution')?(++cov_1lscukmpan.b[20][0],dbRule.institution):(++cov_1lscukmpan.b[20][1],'UIUC')});++cov_1lscukmpan.s[77];sqldb.query(sql.insert_course_instance_access_rule,params,function(err,_result){++cov_1lscukmpan.f[24];++cov_1lscukmpan.s[78];if(ERR(err,callback)){++cov_1lscukmpan.b[21][0];++cov_1lscukmpan.s[79];return;}else{++cov_1lscukmpan.b[21][1];}++cov_1lscukmpan.s[80];callback(null);});},function(err){++cov_1lscukmpan.f[25];++cov_1lscukmpan.s[81];if(ERR(err,callback)){++cov_1lscukmpan.b[22][0];++cov_1lscukmpan.s[82];return;}else{++cov_1lscukmpan.b[22][1];}// delete access rules from the DB that aren't on disk
++cov_1lscukmpan.s[83];logger.debug('Deleting excess course instance access rules for current assessment');var params=(++cov_1lscukmpan.s[84],{course_instance_id:courseInstance.courseInstanceId,last_number:allowAccess.length});++cov_1lscukmpan.s[85];sqldb.query(sql.delete_excess_course_instance_access_rules,params,function(err,_result){++cov_1lscukmpan.f[26];++cov_1lscukmpan.s[86];if(ERR(err,callback)){++cov_1lscukmpan.b[23][0];++cov_1lscukmpan.s[87];return;}else{++cov_1lscukmpan.b[23][1];}++cov_1lscukmpan.s[88];callback(null);});});}};